
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">



<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <script type="text/javascript">

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-19801227-1']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
    <title>prody.atomic.select &mdash; RuleBender</title>
    <link rel="stylesheet" href="../../../_static/css/basic.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/css/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/css/bootswatch-united.min.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/css/prodydocs.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  false
      };
    </script>
    <script type="text/javascript" src="../../../_static/js/jquery-2.0.0.min.js"></script>
    <script type="text/javascript" src="../../../_static/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../../../_static/js/zeroclipboard.min.js"></script>
    <script type="text/javascript" src="../../../_static/js/copybutton.js"></script>
    <script type="text/javascript" src="../../../_static/js/prodydocs.js"></script>
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>

  </head>
  <body data-spy="scroll" data-target="#localtoc" data-offset="190">

<div class="container">
  <div class="row">
    <div class="span12">
      <a href="../../../index.html">
        <img src="../../../_static/logo.png" alt="ProDy logo" id="logo" />
      </a>
    </div>
    <div class="span12">
      <div class="subnav">
        <ul class="nav nav-pills">
        <li class="pull-right">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a>
          </li>
        <li class="pull-right">
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a>
          </li>
        <li><a href="../../../index.html">Home  &raquo;</a></li>
          <li><a href="../../index.html" >Module code &raquo;</a></li>
          <li><a href="../../prody.html" accesskey="U">prody &raquo;</a></li> 
        </ul>
      </div>
    </div>
  </div>

  <div class="content">
  <div class="row">
    <div class="span3">
      <div id="sidebar" style="width: 220px">
        <div class="accordion" id="accordion2">
  <div id="searchbox" class="accordion-group">
    <div class="accordion-heading">
      <a class="accordion-toggle" data-toggle="collapse" data-parent="#accordion2" href="#collapseToolbox">
        <strong>Toolbox</strong>
      </a>
    </div>
<!--     <div id="collapseToolbox" class="accordion-body collapse in">
      <div class="accordion-inner">
        <div id="showcodebuttons" style="margin-bottom: 10px">
          <p><small>Show code snippets for copying:</small></p>
          <div class="btn-group">
            <a href="#codemodal" role="button" data-toggle="modal" id="showcode" class="btn btn-primary btn-small">
              <i class="icon-fullscreen icon-white"></i> Show code</a>
            <a href="#codemodal" role="button" data-toggle="modal" id="withcomments" class="btn btn-primary btn-small">
              and output <i class="icon-comment icon-white"></i> </a>
          </div>
        </div> -->

        <p><small>Search terms or function by name:</small></p>
        <form class="form-search pull-right" action="../../../search.html" method="get">
          <div class="input-append">
            <input type="text" class="input-small search-query" name="q" class="span2">
            <button type="submit" class="btn btn-primary">Go</button>
          </div>
          <input type="hidden" name="check_keywords" value="yes" />
          <input type="hidden" name="area" value="default" />
        </form>
      </div>
    </div>
  </div>  <div class="accordion-group">
    <div class="accordion-heading">
      <a class="accordion-toggle" data-toggle="collapse" data-parent="#accordion2" href="#collapseReleaseNotes">
        <strong>Release Notes</strong>
      </a>
    </div>
    <div id="collapseReleaseNotes" class="accordion-body collapse in">
      <div class="accordion-inner">
        <p><small><strong>v1</strong> series come with new and improved sequence, structure, and dynamics analysis
features. See <a href="../../../manual/release/index.html">release notes</a> for details.
        </small></p>
      </div>
    </div>
  </div>  <div class="accordion-group">
    <div class="accordion-heading">
      <a class="accordion-toggle" data-toggle="collapse" data-parent="#accordion2" href="#collapseHowToCite">
        <strong>How to Cite</strong>
      </a>
    </div>
    <div id="collapseHowToCite" class="accordion-body collapse in">
      <div class="accordion-inner">
        <p><small>
          Bakan A, Meireles LM, Bahar I
          <a class="reference external" href="http://bioinformatics.oxfordjournals.org/content/27/11/1575" target="_blank">
          <i>ProDy</i>: Protein Dynamics Inferred from Theory and Experiments</a> <br/>
          <em>Bioinformatics</em> <strong>2011</strong> 27(11):1575-1577.
        </small></p>
      </div>
    </div>
  </div>
        </div>
      </div>
    </div>
    <div class="span9 body">
    
  <h1>Source code for prody.atomic.select</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;This module defines a class for selecting subsets of atoms.  You can read</span>
<span class="sd">this page in interactive sessions using ``help(select)``.</span>

<span class="sd">ProDy offers a fast and powerful atom selection class, :class:`.Select`.</span>
<span class="sd">Selection features, grammar, and keywords are similar to those of VMD.</span>
<span class="sd">Small differences, that is described below, should not affect most practical</span>
<span class="sd">uses of atom selections.  With added flexibility of Python, ProDy selection</span>
<span class="sd">engine can also be used to identify intermolecular contacts.  You may see</span>
<span class="sd">this and other usage examples in :ref:`contacts` and</span>
<span class="sd">:ref:`selection-operations`.</span>

<span class="sd">First, we import everything from ProDy and parse a protein-DNA-ligand</span>
<span class="sd">complex structure:</span>

<span class="sd">.. ipython:: python</span>

<span class="sd">   from prody import *</span>
<span class="sd">   p = parsePDB(&#39;3mht&#39;)</span>

<span class="sd">:func:`.parsePDB` returns :class:`.AtomGroup` instances, ``p`` in this case,</span>
<span class="sd">that stores all atomic data in the file.  We can count different types of</span>
<span class="sd">atoms using :ref:`flags` and :meth:`~.AtomGroup.numAtoms` method as follows:</span>

<span class="sd">.. ipython:: python</span>

<span class="sd">   p.numAtoms(&#39;protein&#39;)</span>
<span class="sd">   p.numAtoms(&#39;nucleic&#39;)</span>
<span class="sd">   p.numAtoms(&#39;hetero&#39;)</span>
<span class="sd">   p.numAtoms(&#39;water&#39;)</span>

<span class="sd">Last two counts suggest that ligand has 26 atoms, i.e. number of :term:`hetero`</span>
<span class="sd">atoms less the number of :term:`water` atoms.</span>


<span class="sd">Atom flags</span>
<span class="sd">-------------------------------------------------------------------------------</span>

<span class="sd">We select subset of atoms by using :meth:`.AtomGroup.select` method.</span>
<span class="sd">All :ref:`flags` can be input arguments to this methods as follows:</span>

<span class="sd">.. ipython:: python</span>

<span class="sd">   p.select(&#39;protein&#39;)</span>
<span class="sd">   p.select(&#39;water&#39;)</span>

<span class="sd">This operation returns :class:`.Selection` instances, which can be an input</span>
<span class="sd">to functions that accepts an *atoms* argument.</span>


<span class="sd">Logical operators</span>
<span class="sd">-------------------------------------------------------------------------------</span>

<span class="sd">Flags can be combined using ``&#39;and&#39;`` and ``&#39;or&#39;`` operators:</span>

<span class="sd">.. ipython:: python</span>

<span class="sd">   p.select(&#39;protein and water&#39;)</span>

<span class="sd">``&#39;protein and water&#39;`` did not result in selection of :term:`protein` and</span>
<span class="sd">:term:`water` atoms.  This is because, no atom is flagged as a protein and a</span>
<span class="sd">water atom at the same time.</span>

<span class="sd">.. note::</span>

<span class="sd">   **Interpreting selection strings**</span>

<span class="sd">   You may think as if a selection string, such as ``&#39;protein and water&#39;``, is</span>
<span class="sd">   evaluated on a per atom basis and an atom is selected if it satisfies the</span>
<span class="sd">   given criterion.  To select both water and protein atoms, ``&#39;or&#39;`` logical</span>
<span class="sd">   operator should be used instead.  A protein or a water atom would satisfy</span>
<span class="sd">   ``&#39;protein or water&#39;`` criterion.</span>

<span class="sd">.. ipython:: python</span>

<span class="sd">   p.select(&#39;protein or water&#39;)</span>

<span class="sd">We can also use ``&#39;not&#39;`` operator to negate an atom flag.  For example,</span>
<span class="sd">the following selection will only select ligand atoms:</span>

<span class="sd">.. ipython:: python</span>

<span class="sd">   p.select(&#39;not water and hetero&#39;)</span>

<span class="sd">If you omit the ``&#39;and&#39;`` operator, you will get the same result:</span>

<span class="sd">.. ipython:: python</span>

<span class="sd">   p.select(&#39;not water hetero&#39;)</span>

<span class="sd">.. note::</span>

<span class="sd">   **Default operator** between two flags, or other selection tokens that will</span>
<span class="sd">   be discussed later, is ``&#39;and&#39;``.  For example, ``&#39;not water hetero&#39;``</span>
<span class="sd">   is equivalent to ``&#39;not water and hetero&#39;``.</span>

<span class="sd">We can select Cα atoms of acidic residues by omitting the default logical</span>
<span class="sd">operator as follows:</span>

<span class="sd">.. ipython:: python</span>

<span class="sd">   sel = p.select(&#39;acidic calpha&#39;)</span>
<span class="sd">   sel</span>
<span class="sd">   set(sel.getResnames())</span>


<span class="sd">Quick selections</span>
<span class="sd">-------------------------------------------------------------------------------</span>

<span class="sd">For simple selections, such as shown above, following may be preferable over</span>
<span class="sd">the :meth:`~.AtomGroup.select` method:</span>

<span class="sd">.. ipython:: python</span>

<span class="sd">   p.acidic_calpha</span>

<span class="sd">The result is the same as using ``p.select(&#39;acidic calpha&#39;)``.  Underscore,</span>
<span class="sd">``_``, is considered as a whitespace.  The limitation of this approach is that</span>
<span class="sd">special characters cannot be used.</span>


<span class="sd">Atom data fields</span>
<span class="sd">-------------------------------------------------------------------------------</span>

<span class="sd">In addition to :ref:`flags`, :ref:`fields` can be used in atom selections</span>
<span class="sd">when combined with some values.  For example, we can select Cα and Cβ atoms</span>
<span class="sd">of alanine residues as follows:</span>

<span class="sd">.. ipython:: python</span>

<span class="sd">   p.select(&#39;resname ALA name CA CB&#39;)</span>

<span class="sd">Note that we omitted the default ``&#39;and&#39;`` operator.</span>

<span class="sd">.. note::</span>

<span class="sd">   **Whitespace** or **empty string** can be specified using an ``&#39;_&#39;``.</span>
<span class="sd">   Atoms with string data fields empty, such as those with no a chain</span>
<span class="sd">   identifiers or alternate location identifiers, can be selected using</span>
<span class="sd">   an underscore.</span>


<span class="sd">.. ipython:: python</span>

<span class="sd">   p.select(&#39;chain _&#39;)  # chain identifiers of all atoms are specified in 3mht</span>
<span class="sd">   p.select(&#39;altloc _&#39;)  # altloc identifiers for all atoms are empty</span>

<span class="sd">Numeric data fields can also be used to make selections:</span>

<span class="sd">.. ipython:: python</span>

<span class="sd">   p.select(&#39;ca resnum 1 2 3 4&#39;)</span>


<span class="sd">A special case for residues is having insertion codes.  Residue numbers and</span>
<span class="sd">insertion codes can be specified together as follows:</span>

<span class="sd">  * ``&#39;resnum 5&#39;`` selects residue 5 (all insertion codes)</span>
<span class="sd">  * ``&#39;resnum 5A&#39;`` selects residue 5 with insertion code A</span>
<span class="sd">  * ``&#39;resnum 5_&#39;`` selects residue 5 with no insertion code</span>


<span class="sd">Number ranges</span>
<span class="sd">^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^</span>

<span class="sd">A range of numbers using ``&#39;to&#39;`` or Python style slicing with ``&#39;:&#39;``:</span>

<span class="sd">.. ipython:: python</span>

<span class="sd">   p.select(&#39;ca resnum 1to4&#39;)</span>
<span class="sd">   p.select(&#39;ca resnum 1:4&#39;)</span>
<span class="sd">   p.select(&#39;ca resnum 1:4:2&#39;)</span>

<span class="sd">.. note::</span>

<span class="sd">   **Number ranges** specify continuous intervals:</span>

<span class="sd">     * ``&#39;to&#39;`` is all inclusive, e.g. ``&#39;resnum 1 to 4&#39;`` means</span>
<span class="sd">       ``&#39;1 &lt;= resnum &lt;= 4&#39;``</span>

<span class="sd">     * ``&#39;:&#39;`` is left inclusive, e.g. ``&#39;resnum 1:4&#39;`` means</span>
<span class="sd">       ``&#39;1 &lt;= resnum &lt; 4&#39;``</span>

<span class="sd">   Consecutive use of ``&#39;:&#39;``, however, specifies a discrete range of numbers,</span>
<span class="sd">   e.g. ``&#39;resnum 1:4:2&#39;`` means ``&#39;resnum 1 3&#39;``</span>


<span class="sd">Special characters</span>
<span class="sd">^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^</span>

<span class="sd">Following characters can be specified when using :ref:`fields` for atom</span>
<span class="sd">selections::</span>

<span class="sd">  abcdefghijklmnopqrstuvwxyz</span>
<span class="sd">  ABCDEFGHIJKLMNOPQRSTUVWXYZ</span>
<span class="sd">  0123456789</span>
<span class="sd">  ~@#$.:;_&#39;,</span>

<span class="sd">For example, ``&quot;name C&#39; N` O~ C$ C#&quot;`` is a valid selection string.</span>

<span class="sd">.. note::</span>

<span class="sd">   **Special characters** (``~!@#$%^&amp;*()-_=+[{}]\|;:,&lt;&gt;./?()&#39;&quot;``) must be</span>
<span class="sd">   escaped using grave accent characters (``````).</span>


<span class="sd">Negative numbers</span>
<span class="sd">^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^</span>

<span class="sd">Negative numbers and number ranges must also be escaped using grave accent</span>
<span class="sd">characters, since negative sign ``&#39;-&#39;`` is considered a special character</span>
<span class="sd">unless it indicates subtraction operation (see below).</span>

<span class="sd">.. ipython:: python</span>

<span class="sd">   p.select(&#39;x `-25 to 25`&#39;)</span>
<span class="sd">   p.select(&#39;x `-22.542`&#39;)</span>


<span class="sd">Omitting the grave accent character will cause a :exc:`.SelectionError`.</span>


<span class="sd">Regular expressions</span>
<span class="sd">^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^</span>

<span class="sd">Finally, you can specify regular expressions to select atoms based on</span>
<span class="sd">data fields with type string.  Following will select residues whose names</span>
<span class="sd">start with capital letter A</span>

<span class="sd">.. ipython:: python</span>

<span class="sd">   sel = p.select(&#39;resname &quot;A.*&quot;&#39;)</span>
<span class="sd">   set(sel.getResnames())</span>


<span class="sd">.. note::</span>

<span class="sd">   **Regular expressions** can be specified using double quotes, ``&quot;...&quot;``.</span>
<span class="sd">   For more information on regular expressions see :mod:`re`.</span>


<span class="sd">Numerical comparisons</span>
<span class="sd">-------------------------------------------------------------------------------</span>

<span class="sd">:ref:`fields` with numeric types can be used as operands in numerical</span>
<span class="sd">comparisons:</span>

<span class="sd">.. ipython:: python</span>

<span class="sd">   p.select(&#39;x &lt; 0&#39;)</span>
<span class="sd">   p.select(&#39;occupancy = 1&#39;)</span>

<span class="sd">==========  =================================</span>
<span class="sd">Comparison  Description</span>
<span class="sd">==========  =================================</span>
<span class="sd">   &lt;        less than</span>
<span class="sd">   &gt;        greater than</span>
<span class="sd">   &lt;=       less than or equal</span>
<span class="sd">   &gt;=       greater than or equal</span>
<span class="sd">   ==       equal</span>
<span class="sd">   =        equal</span>
<span class="sd">   !=       not equal</span>
<span class="sd">==========  =================================</span>

<span class="sd">It is also possible to chain comparison statements as follows:</span>

<span class="sd">.. ipython:: python</span>

<span class="sd">   p.select(&#39;-10 &lt;= x &lt; 0&#39;)</span>

<span class="sd">This would be the same as the following selection:</span>

<span class="sd">.. ipython:: python</span>

<span class="sd">   p.select(&#39;-10 &lt;= x and x &lt; 0&#39;) == p.select(&#39;-10 &lt;= x &lt; 0&#39;)</span>

<span class="sd">Furthermore, numerical comparisons may involve the following operations:</span>

<span class="sd">=========  ==================================</span>
<span class="sd">Operation  Description</span>
<span class="sd">=========  ==================================</span>
<span class="sd">x ** y     x to the power y</span>
<span class="sd">x ^ y      x to the power y</span>
<span class="sd">x * y      x times y</span>
<span class="sd">x / y      x divided by y</span>
<span class="sd">x // y     x divided by y (floor division)</span>
<span class="sd">x % y      x modulo y</span>
<span class="sd">x + y      x plus y</span>
<span class="sd">x - y      x minus y</span>
<span class="sd">=========  ==================================</span>

<span class="sd">These operations must be used with a numerical comparison, e.g.</span>

<span class="sd">.. ipython:: python</span>

<span class="sd">   p.select(&#39;x ** 2 &lt; 10&#39;)</span>
<span class="sd">   p.select(&#39;x ** 2 ** 2 &lt; 10&#39;)</span>

<span class="sd">Finally, following functions can be used in numerical comparisons:</span>

<span class="sd">========  ===================================</span>
<span class="sd">Function  Description</span>
<span class="sd">========  ===================================</span>
<span class="sd">abs(x)    absolute value of x</span>
<span class="sd">acos(x)   arccos of x</span>
<span class="sd">asin(x)   arcsin of x</span>
<span class="sd">atan(x)   arctan of x</span>
<span class="sd">ceil(x)   smallest integer not less than x</span>
<span class="sd">cos(x)    cosine of x</span>
<span class="sd">cosh(x)   hyperbolic cosine of x</span>
<span class="sd">floor(x)  largest integer not greater than x</span>
<span class="sd">exp(x)    e to the power x</span>
<span class="sd">log(x)    natural logarithm of x</span>
<span class="sd">log10(x)  base 10 logarithm of x</span>
<span class="sd">sin(x)    sine of x</span>
<span class="sd">sinh(x)   hyperbolic sine of x</span>
<span class="sd">sq(x)     square of x</span>
<span class="sd">sqrt(x)   square-root of x</span>
<span class="sd">tan(x)    tangent of x</span>
<span class="sd">tanh(x)   hyperbolic tangent of x</span>
<span class="sd">========  ===================================</span>

<span class="sd">.. ipython:: python</span>

<span class="sd">   p.select(&#39;sqrt(sq(x) + sq(y) + sq(z)) &lt; 100&#39;)  # within 100 A of origin</span>


<span class="sd">Distance based selections</span>
<span class="sd">-------------------------------------------------------------------------------</span>

<span class="sd">Atoms within a user specified distance (A) from a set of user specified atoms</span>
<span class="sd">can be selected using ``&#39;within . of .&#39;`` keyword, e.g. ``&#39;within 5 of water&#39;``</span>
<span class="sd">selects atoms that are within 5 A of water molecules. This setting will</span>
<span class="sd">results selecting water atoms as well.</span>

<span class="sd">User can avoid selecting specified atoms using ``exwithin . of ..`` setting,</span>
<span class="sd">e.g. ``&#39;exwithin 5 of water&#39;`` will not select water molecules and is</span>
<span class="sd">equivalent to ``&#39;within 5 of water and not water&#39;``</span>

<span class="sd">.. ipython:: python</span>

<span class="sd">   p.select(&#39;exwithin 5 of water&#39;) == p.select(&#39;not water within 5 of water&#39;)</span>


<span class="sd">Sequence selections</span>
<span class="sd">-------------------------------------------------------------------------------</span>

<span class="sd">One-letter amino acid sequences can be used to make atom selections.</span>
<span class="sd">``&#39;sequence SAR&#39;`` will select **SER-ALA-ARG** residues in a chain.  Note</span>
<span class="sd">that the selection does not consider connectivity within a chain.  Regular</span>
<span class="sd">expressions can also be used to make selections: ``&#39;sequence &quot;MI.*KQ&quot;&#39;`` will</span>
<span class="sd">select **MET-ILE-(XXX)n-ASP-LYS-GLN** pattern, if present.</span>

<span class="sd">.. ipython:: python</span>

<span class="sd">   sel = p.select(&#39;ca sequence &quot;MI.*DKQ&quot;&#39;)</span>
<span class="sd">   sel</span>
<span class="sd">   sel.getResnames()</span>


<span class="sd">Expanding selections</span>
<span class="sd">-------------------------------------------------------------------------------</span>

<span class="sd">A selection can be expanded to include the atoms in the same *residue*,</span>
<span class="sd">*chain*, or *segment* using ``same .. as ..`` setting, e.g.</span>
<span class="sd">``&#39;same residue as exwithin 4 of water&#39;`` will select residues that have</span>
<span class="sd">at least an atom within 4 A of any water molecule.</span>

<span class="sd">.. ipython:: python</span>

<span class="sd">   p.select(&#39;same residue as exwithin 4 of water&#39;)</span>

<span class="sd">Additionally, a selection may be expanded to the immediately bonded atoms using</span>
<span class="sd">``bonded [n] to ...`` setting, e.f. ``bonded 1 to calpha`` will select atoms</span>
<span class="sd">bonded to Cα atoms.  For this setting to work, bonds must be set by the user</span>
<span class="sd">using the :meth:`.AtomGroup.setBonds` method.  It is also possible to select</span>
<span class="sd">bonded atoms by excluding the originating atoms using ``exbonded [n] to ...``</span>
<span class="sd">setting.  Number ``&#39;[n]&#39;`` indicates number of bonds to consider from the</span>
<span class="sd">originating selection and defaults to 1.</span>


<span class="sd">Selection macros</span>
<span class="sd">-------------------------------------------------------------------------------</span>

<span class="sd">ProDy allows you to define a macro for any valid selection string.  Below</span>
<span class="sd">functions are for manipulating selection macros:</span>

<span class="sd">  * :func:`defSelectionMacro`</span>
<span class="sd">  * :func:`delSelectionMacro`</span>
<span class="sd">  * :func:`getSelectionMacro`</span>
<span class="sd">  * :func:`isSelectionMacro`</span>

<span class="sd">.. ipython:: python</span>

<span class="sd">   defSelectionMacro(&#39;alanine&#39;, &#39;resname ALA&#39;)</span>
<span class="sd">   p.select(&#39;alanine&#39;) == p.select(&#39;resname ALA&#39;)</span>

<span class="sd">You can also use this macro as follows:</span>

<span class="sd">.. ipython:: python</span>

<span class="sd">   p.alanine</span>

<span class="sd">Macros are stored in ProDy configuration file permanently.  You can delete</span>
<span class="sd">them if you wish as follows:</span>

<span class="sd">.. ipython:: python</span>

<span class="sd">   delSelectionMacro(&#39;alanine&#39;)</span>


<span class="sd">Keyword arguments</span>
<span class="sd">-------------------------------------------------------------------------------</span>

<span class="sd">:meth:`~.Select.select` method also accepts keyword arguments that can simplify</span>
<span class="sd">some selections.  Consider the following case where you want to select some</span>
<span class="sd">protein atoms that are close to its center:</span>

<span class="sd">.. ipython:: python</span>

<span class="sd">   protein = p.protein</span>
<span class="sd">   calcCenter(protein).round(2)</span>
<span class="sd">   sel1 = protein.select(&#39;sqrt(sq(x--21.17) + sq(y-35.86) + sq(z-79.97)) &lt; 5&#39;)</span>
<span class="sd">   sel1</span>

<span class="sd">Instead, you could pass a keyword argument and use the keyword in the</span>
<span class="sd">selection string:</span>

<span class="sd">.. ipython:: python</span>

<span class="sd">   sel2 = protein.select(&#39;within 5 of center&#39;, center=calcCenter(protein))</span>
<span class="sd">   sel2</span>
<span class="sd">   sel1 == sel2</span>

<span class="sd">Note that selection string for *sel2* lists indices of atoms.  This</span>
<span class="sd">substitution is performed automatically to ensure reproducibility of the</span>
<span class="sd">selection without the keyword *center*.</span>

<span class="sd">Keywords cannot be reserved words (see :func:`.listReservedWords`) and must be</span>
<span class="sd">all alphanumeric characters.&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">re</span> <span class="kn">import</span> <span class="nb">compile</span> <span class="k">as</span> <span class="n">re_compile</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">Iterable</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">array</span><span class="p">,</span> <span class="n">ndarray</span><span class="p">,</span> <span class="n">ones</span><span class="p">,</span> <span class="n">zeros</span><span class="p">,</span> <span class="n">arange</span>
<span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">invert</span><span class="p">,</span> <span class="n">unique</span><span class="p">,</span> <span class="n">concatenate</span><span class="p">,</span> <span class="nb">all</span><span class="p">,</span> <span class="nb">any</span>
<span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">logical_and</span><span class="p">,</span> <span class="n">logical_or</span><span class="p">,</span> <span class="n">floor</span><span class="p">,</span> <span class="n">ceil</span><span class="p">,</span> <span class="n">where</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">pyparsing</span> <span class="k">as</span> <span class="n">pp</span>
    <span class="kn">from</span> <span class="nn">.pyparsing</span> <span class="kn">import</span> <span class="n">ParseException</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">pyparsing</span> <span class="kn">as</span> <span class="nn">pp</span>
    <span class="kn">from</span> <span class="nn">pyparsing</span> <span class="kn">import</span> <span class="n">ParseException</span>


<span class="kn">from</span> <span class="nn">prody</span> <span class="kn">import</span> <span class="n">LOGGER</span><span class="p">,</span> <span class="n">SETTINGS</span><span class="p">,</span> <span class="n">PY2K</span>

<span class="kn">from</span> <span class="nn">.atomic</span> <span class="kn">import</span> <span class="n">Atomic</span>
<span class="kn">from</span> <span class="nn">.fields</span> <span class="kn">import</span> <span class="n">ATOMIC_FIELDS</span>
<span class="kn">from</span> <span class="nn">.flags</span> <span class="kn">import</span> <span class="n">PLANTERS</span> <span class="k">as</span> <span class="n">FLAG_PLANTERS</span>

<span class="kn">from</span> <span class="nn">.atomgroup</span> <span class="kn">import</span> <span class="n">AtomGroup</span>
<span class="kn">from</span> <span class="nn">.chain</span> <span class="kn">import</span> <span class="n">Chain</span><span class="p">,</span> <span class="n">getSequence</span><span class="p">,</span> <span class="n">AAMAP</span>
<span class="kn">from</span> <span class="nn">.pointer</span> <span class="kn">import</span> <span class="n">AtomPointer</span>
<span class="kn">from</span> <span class="nn">.selection</span> <span class="kn">import</span> <span class="n">Selection</span>
<span class="kn">from</span> <span class="nn">.segment</span> <span class="kn">import</span> <span class="n">Segment</span>
<span class="kn">from</span> <span class="nn">.atommap</span> <span class="kn">import</span> <span class="n">AtomMap</span>

<span class="kn">from</span> <span class="nn">prody.utilities</span> <span class="kn">import</span> <span class="n">rangeString</span>
<span class="kn">from</span> <span class="nn">prody.kdtree</span> <span class="kn">import</span> <span class="n">KDTree</span>

<span class="k">if</span> <span class="n">PY2K</span><span class="p">:</span>
    <span class="nb">range</span> <span class="o">=</span> <span class="nb">xrange</span>

<span class="n">DEBUG</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">NUMB</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># Select instance will not really evaluate string for the atoms</span>
<span class="n">TIMER</span> <span class="o">=</span> <span class="mi">0</span>

<span class="k">def</span> <span class="nf">debug</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">args</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
        <span class="k">print</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">sel</span><span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="p">(</span><span class="n">loc</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;^&#39;</span><span class="p">)</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Select&#39;</span><span class="p">,</span> <span class="s1">&#39;SelectionError&#39;</span><span class="p">,</span> <span class="s1">&#39;SelectionWarning&#39;</span><span class="p">,</span>
           <span class="s1">&#39;defSelectionMacro&#39;</span><span class="p">,</span> <span class="s1">&#39;delSelectionMacro&#39;</span><span class="p">,</span> <span class="s1">&#39;getSelectionMacro&#39;</span><span class="p">,</span>
           <span class="s1">&#39;isSelectionMacro&#39;</span><span class="p">]</span>

<span class="n">ATOMGROUP</span> <span class="o">=</span> <span class="bp">None</span>

<span class="n">MACROS</span> <span class="o">=</span> <span class="n">SETTINGS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;selection_macros&#39;</span><span class="p">,</span> <span class="p">{})</span>
<span class="n">MACROS_REGEX</span> <span class="o">=</span> <span class="bp">None</span>


<div class="viewcode-block" id="isSelectionMacro"><a class="viewcode-back" href="../../../manual/reference/atomic/select.html#prody.atomic.select.isSelectionMacro">[docs]</a><span class="k">def</span> <span class="nf">isSelectionMacro</span><span class="p">(</span><span class="n">word</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns **True** if *word* is a user defined selection macro.&quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">MACROS</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span></div>


<div class="viewcode-block" id="defSelectionMacro"><a class="viewcode-back" href="../../../manual/reference/atomic/select.html#prody.atomic.select.defSelectionMacro">[docs]</a><span class="k">def</span> <span class="nf">defSelectionMacro</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">selstr</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Define selection macro *selstr* with name *name*.  Both *name* and</span>
<span class="sd">    *selstr* must be string.  An existing keyword cannot be used as a macro</span>
<span class="sd">    name. If a macro with given *name* exists, it will be overwritten.</span>

<span class="sd">    .. ipython:: python</span>

<span class="sd">       defSelectionMacro(&#39;cbeta&#39;, &#39;name CB and protein&#39;)&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">selstr</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;both name and selstr must be strings&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">isReserved</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;{0} is a reserved word and cannot be used as a &#39;</span>
                         <span class="s1">&#39;macro name&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">name</span><span class="p">)))</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">isalpha</span><span class="p">()</span> <span class="ow">and</span> <span class="n">name</span><span class="o">.</span><span class="n">islower</span><span class="p">()):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;macro names must be all lower case letters, {0} &#39;</span>
                         <span class="s1">&#39;is not a valid macro name&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">name</span><span class="p">)))</span>

    <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Testing validity of selection string.&#39;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">ATOMGROUP</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">selstr</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">SelectionError</span><span class="p">:</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;{0} is not a valid selection string, macro {1} is not&#39;</span>
                    <span class="s1">&#39;defined.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">selstr</span><span class="p">),</span> <span class="nb">repr</span><span class="p">(</span><span class="n">name</span><span class="p">)))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Macro {0} is defined as {1}.&quot;</span>
                    <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="nb">repr</span><span class="p">(</span><span class="n">selstr</span><span class="p">)))</span>
        <span class="n">MACROS</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">selstr</span>
        <span class="n">SETTINGS</span><span class="p">[</span><span class="s1">&#39;selection_macros&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">MACROS</span>
        <span class="n">SETTINGS</span><span class="o">.</span><span class="n">save</span><span class="p">()</span></div>


<div class="viewcode-block" id="delSelectionMacro"><a class="viewcode-back" href="../../../manual/reference/atomic/select.html#prody.atomic.select.delSelectionMacro">[docs]</a><span class="k">def</span> <span class="nf">delSelectionMacro</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Delete the macro *name*.</span>

<span class="sd">    .. ipython:: python</span>

<span class="sd">       delSelectionMacro(&#39;cbeta&#39;)&quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">MACROS</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Macro {0} is not found.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">name</span><span class="p">)))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">MACROS_REGEX</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span> <span class="n">MACROS_REGEX</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Macro {0} is deleted.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">name</span><span class="p">)))</span>
        <span class="n">SETTINGS</span><span class="p">[</span><span class="s1">&#39;selection_macros&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">MACROS</span>
        <span class="n">SETTINGS</span><span class="o">.</span><span class="n">save</span><span class="p">()</span></div>


<div class="viewcode-block" id="getSelectionMacro"><a class="viewcode-back" href="../../../manual/reference/atomic/select.html#prody.atomic.select.getSelectionMacro">[docs]</a><span class="k">def</span> <span class="nf">getSelectionMacro</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns the definition of the macro *name*.  If *name* is not given,</span>
<span class="sd">    returns a copy of the selection macros dictionary.&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">MACROS</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">MACROS</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;{0} is not a user defined macro name.&quot;</span>
                    <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">name</span><span class="p">)))</span></div>


<span class="k">def</span> <span class="nf">replaceMacros</span><span class="p">(</span><span class="n">selstr</span><span class="p">):</span>

    <span class="k">global</span> <span class="n">MACROS_REGEX</span>
    <span class="k">if</span> <span class="n">MACROS_REGEX</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="n">MACROS_REGEX</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">selstr</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">selstr</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span>
    <span class="k">if</span> <span class="n">MACROS</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">macro</span> <span class="ow">in</span> <span class="n">MACROS</span><span class="o">.</span><span class="n">items</span><span class="p">():</span> <span class="c1"># PY3K: OK</span>
            <span class="n">re</span> <span class="o">=</span> <span class="n">MACROS_REGEX</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">name</span><span class="p">,</span>
                <span class="n">re_compile</span><span class="p">(</span><span class="s1">&#39;[( )]&#39;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;[( )]&#39;</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">selstr</span><span class="p">):</span>
            <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">start</span><span class="p">(),</span> <span class="n">match</span><span class="o">.</span><span class="n">end</span><span class="p">()</span>
            <span class="n">match</span> <span class="o">=</span> <span class="n">selstr</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">]</span>
            <span class="n">selstr</span> <span class="o">=</span> <span class="p">(</span><span class="n">selstr</span><span class="p">[:</span><span class="n">start</span><span class="p">]</span> <span class="o">+</span> <span class="n">match</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;(&#39;</span> <span class="o">+</span> <span class="n">macro</span><span class="o">+</span> <span class="s1">&#39;)&#39;</span> <span class="o">+</span>
                      <span class="n">match</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">selstr</span><span class="p">[</span><span class="n">end</span><span class="p">:])</span>
    <span class="k">return</span> <span class="n">selstr</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">checkSelstr</span><span class="p">(</span><span class="n">selstr</span><span class="p">,</span> <span class="n">what</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="ne">ValueError</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Check *selstr* if it satisfies a selected condition.  For now, only</span>
<span class="sd">    whether coordinate/distance based selection are checked.  If *error* is</span>
<span class="sd">    a subclass of :exc:`Exception`, an exception will be raised, otherwise</span>
<span class="sd">    return **True** or **False** will be returned.&quot;&quot;&quot;</span>

    <span class="n">selstr</span> <span class="o">=</span> <span class="n">selstr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="p">,</span> <span class="s1">&#39; ( &#39;</span><span class="p">)</span>
    <span class="n">selstr</span> <span class="o">=</span> <span class="n">selstr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;)&#39;</span><span class="p">,</span> <span class="s1">&#39; ) &#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">what</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">([</span><span class="s1">&#39;dist&#39;</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">selstr</span><span class="o">.</span><span class="n">split</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">XYZDIST</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="ne">Exception</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="n">error</span><span class="p">(</span><span class="s1">&#39;invalid selection {0}, coordinate &#39;</span>
                                <span class="s1">&#39;based selections are not accepted&#39;</span>
                                <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">selstr</span><span class="p">)))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">False</span>


<div class="viewcode-block" id="SelectionError"><a class="viewcode-back" href="../../../manual/reference/atomic/select.html#prody.atomic.select.SelectionError">[docs]</a><span class="k">class</span> <span class="nc">SelectionError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Exception raised when there are errors in the selection string.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">tkns</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">tkns</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">tkn</span> <span class="ow">in</span> <span class="n">tkns</span><span class="p">:</span>
                <span class="n">tkn</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">tkn</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">sel</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">tkn</span><span class="p">,</span> <span class="n">loc</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="n">loc</span> <span class="o">=</span> <span class="n">sel</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">tkn</span><span class="p">,</span> <span class="n">loc</span><span class="p">)</span>

        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;An invalid selection string is encountered:</span><span class="se">\n</span><span class="s2">{0}</span><span class="se">\n</span><span class="s2">&quot;</span>
               <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">sel</span><span class="p">))</span> <span class="o">+</span>
               <span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="p">(</span><span class="n">loc</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;^ &#39;</span> <span class="o">+</span> <span class="n">msg</span><span class="p">)</span>
        <span class="ne">Exception</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span></div>


<div class="viewcode-block" id="SelectionWarning"><a class="viewcode-back" href="../../../manual/reference/atomic/select.html#prody.atomic.select.SelectionWarning">[docs]</a><span class="k">class</span> <span class="nc">SelectionWarning</span><span class="p">(</span><span class="ne">Warning</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;A class used for issuing warning messages when potential typos are</span>
<span class="sd">    detected in a selection string.  Warnings are issued to ``sys.stderr``</span>
<span class="sd">    via ProDy package logger.  Use :func:`.confProDy` to selection warnings</span>
<span class="sd">    *on* or *off*, e.g. ``confProDy(selection_warning=False)``.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sel</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">tkns</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">SETTINGS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;selection_warning&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">):</span>

            <span class="k">if</span> <span class="n">tkns</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">tkn</span> <span class="ow">in</span> <span class="n">tkns</span><span class="p">:</span>
                    <span class="n">tkn</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">tkn</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">sel</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">tkn</span><span class="p">,</span> <span class="n">loc</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="n">loc</span> <span class="o">=</span> <span class="n">sel</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">tkn</span><span class="p">,</span> <span class="n">loc</span><span class="p">)</span>

            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Selection string contains typo(s):</span><span class="se">\n</span><span class="s1">&#39;</span>
                   <span class="s1">&#39;{0}</span><span class="se">\n</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">sel</span><span class="p">))</span> <span class="o">+</span>
                   <span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="n">loc</span> <span class="o">+</span> <span class="s1">&#39;^ &#39;</span> <span class="o">+</span> <span class="n">msg</span><span class="p">)</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span></div>

<span class="n">FIELDS_SYNONYMS</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;chid&#39;</span><span class="p">:</span> <span class="s1">&#39;chain&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;fragment&#39;</span><span class="p">:</span> <span class="s1">&#39;fragindex&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;resid&#39;</span><span class="p">:</span> <span class="s1">&#39;resnum&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;secstr&#39;</span><span class="p">:</span> <span class="s1">&#39;secondary&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;segname&#39;</span><span class="p">:</span> <span class="s1">&#39;segment&#39;</span><span class="p">}</span>


<span class="n">XYZ2INDEX</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;z&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">}</span>

<span class="n">FUNCTIONS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;sqrt&#39;</span>  <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">,</span>
    <span class="s1">&#39;sq&#39;</span>    <span class="p">:</span> <span class="k">lambda</span> <span class="n">num</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
    <span class="s1">&#39;abs&#39;</span>   <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">,</span>
    <span class="s1">&#39;floor&#39;</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">,</span>
    <span class="s1">&#39;ceil&#39;</span>  <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">,</span>
    <span class="s1">&#39;sin&#39;</span>   <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">,</span>
    <span class="s1">&#39;cos&#39;</span>   <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">,</span>
    <span class="s1">&#39;tan&#39;</span>   <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">tan</span><span class="p">,</span>
    <span class="s1">&#39;asin&#39;</span>  <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">arcsin</span><span class="p">,</span>
    <span class="s1">&#39;acos&#39;</span>  <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">,</span>
    <span class="s1">&#39;atan&#39;</span>  <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">,</span>
    <span class="s1">&#39;sinh&#39;</span>  <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sinh</span><span class="p">,</span>
    <span class="s1">&#39;cosh&#39;</span>  <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">cosh</span><span class="p">,</span>
    <span class="s1">&#39;tahn&#39;</span>  <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">tanh</span><span class="p">,</span>
    <span class="s1">&#39;exp&#39;</span>   <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">,</span>
    <span class="s1">&#39;log&#39;</span>   <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">,</span>
    <span class="s1">&#39;log10&#39;</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">OPERATORS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;+&#39;</span>  <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">,</span>
    <span class="s1">&#39;-&#39;</span>  <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="p">,</span>
    <span class="s1">&#39;*&#39;</span>  <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">,</span>
    <span class="s1">&#39;/&#39;</span>  <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">,</span>
    <span class="s1">&#39;%&#39;</span>  <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">remainder</span><span class="p">,</span>
    <span class="s1">&#39;&gt;&#39;</span>  <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">greater</span><span class="p">,</span>
    <span class="s1">&#39;&lt;&#39;</span>  <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">less</span><span class="p">,</span>
    <span class="s1">&#39;&gt;=&#39;</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">greater_equal</span><span class="p">,</span>
    <span class="s1">&#39;&lt;=&#39;</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">less_equal</span><span class="p">,</span>
    <span class="s1">&#39;=&#39;</span>  <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">equal</span><span class="p">,</span>
    <span class="s1">&#39;==&#39;</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">equal</span><span class="p">,</span>
    <span class="s1">&#39;!=&#39;</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">not_equal</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">SAMEAS_MAP</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;residue&#39;</span><span class="p">:</span> <span class="s1">&#39;resindex&#39;</span><span class="p">,</span> <span class="s1">&#39;chain&#39;</span><span class="p">:</span> <span class="s1">&#39;chindex&#39;</span><span class="p">,</span>
              <span class="s1">&#39;segment&#39;</span><span class="p">:</span> <span class="s1">&#39;segindex&#39;</span><span class="p">,</span> <span class="s1">&#39;fragment&#39;</span><span class="p">:</span> <span class="s1">&#39;fragindex&#39;</span><span class="p">}</span>

<span class="c1"># maybe a value to a field/data label or field label</span>
<span class="n">XYZ</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;z&#39;</span><span class="p">])</span>
<span class="n">XYZDIST</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="s1">&#39;within&#39;</span><span class="p">,</span> <span class="s1">&#39;exwithin&#39;</span><span class="p">])</span>

<span class="n">OR</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">Keyword</span><span class="p">(</span><span class="s1">&#39;or&#39;</span><span class="p">)</span>
<span class="n">AND</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">Keyword</span><span class="p">(</span><span class="s1">&#39;and&#39;</span><span class="p">)</span>
<span class="n">WORD</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">Word</span><span class="p">(</span><span class="n">pp</span><span class="o">.</span><span class="n">alphanums</span> <span class="o">+</span> <span class="s1">&#39;&#39;&#39;~@#$.:;_&#39;`,&#39;&#39;&#39;</span><span class="p">)</span>

<span class="n">_</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">FUNCTIONS</span><span class="p">)</span>
<span class="n">FUNCNAMES</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">_</span><span class="p">)</span>

<span class="n">kwfunc</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">Keyword</span><span class="p">(</span><span class="n">_</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">FUNCNAMES_OPLIST</span> <span class="o">=</span> <span class="n">kwfunc</span>
<span class="n">FUNCNAMES_EXPR</span> <span class="o">=</span> <span class="o">~</span><span class="n">kwfunc</span>
<span class="k">for</span> <span class="n">func</span> <span class="ow">in</span> <span class="n">_</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
    <span class="n">kwfunc</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">Keyword</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="n">FUNCNAMES_OPLIST</span> <span class="o">=</span> <span class="n">FUNCNAMES_OPLIST</span> <span class="o">|</span> <span class="n">kwfunc</span>
    <span class="n">FUNCNAMES_EXPR</span> <span class="o">+=</span> <span class="o">~</span><span class="n">kwfunc</span>

<span class="n">RE_SCHARS</span> <span class="o">=</span> <span class="n">re_compile</span><span class="p">(</span><span class="s1">&#39;`[\w\W]*?`&#39;</span><span class="p">)</span>
<span class="n">PP_SCHARS</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">Regex</span><span class="p">(</span><span class="n">RE_SCHARS</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">specialCharsParseAction</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">token</span><span class="p">):</span>

    <span class="n">token</span> <span class="o">=</span> <span class="n">token</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">token</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">SelectionError</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="s1">&#39;`` is invalid, no special characters&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;:&#39;</span> <span class="ow">in</span> <span class="n">token</span> <span class="ow">or</span> <span class="s1">&#39;to&#39;</span> <span class="ow">in</span> <span class="n">token</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">token</span> <span class="o">=</span> <span class="n">PP_NRANGE</span><span class="o">.</span><span class="n">parseString</span><span class="p">(</span><span class="n">token</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span> <span class="n">ParseException</span><span class="p">:</span>
            <span class="k">pass</span>
    <span class="k">return</span> <span class="n">token</span>

<span class="n">PP_SCHARS</span><span class="o">.</span><span class="n">setParseAction</span><span class="p">(</span><span class="n">specialCharsParseAction</span><span class="p">)</span>


<span class="n">RE_REGEXP</span> <span class="o">=</span> <span class="n">re_compile</span><span class="p">(</span><span class="s1">&#39;&quot;[\w\W]*&quot;&#39;</span><span class="p">)</span>
<span class="n">PP_REGEXP</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">Regex</span><span class="p">(</span><span class="n">RE_REGEXP</span><span class="o">.</span><span class="n">pattern</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">regularExpParseAction</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">token</span><span class="p">):</span>

    <span class="n">token</span> <span class="o">=</span> <span class="n">token</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">token</span> <span class="o">==</span> <span class="s1">&#39;&quot;&quot;&#39;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">SelectionError</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="s1">&#39;&quot;&quot; is invalid, no regular expression&#39;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">regexp</span> <span class="o">=</span> <span class="n">re_compile</span><span class="p">(</span><span class="n">token</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">SelectionError</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="s1">&#39;failed to compile regular &#39;</span>
                             <span class="s1">&#39;expression {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">token</span><span class="p">)))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">regexp</span>

<span class="n">PP_REGEXP</span><span class="o">.</span><span class="n">setParseAction</span><span class="p">(</span><span class="n">regularExpParseAction</span><span class="p">)</span>

<span class="n">_</span> <span class="o">=</span> <span class="s1">&#39;[-+]?\d+(\.\d*)?([eE]\d+)?&#39;</span>
<span class="n">RE_NRANGE</span> <span class="o">=</span> <span class="n">re_compile</span><span class="p">(</span><span class="n">_</span> <span class="o">+</span> <span class="s1">&#39;\ *(to|:)\ *&#39;</span> <span class="o">+</span> <span class="n">_</span><span class="p">)</span>

<span class="n">PP_NRANGE</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">Group</span><span class="p">(</span><span class="n">pp</span><span class="o">.</span><span class="n">Regex</span><span class="p">(</span><span class="n">RE_NRANGE</span><span class="o">.</span><span class="n">pattern</span><span class="p">)</span> <span class="o">+</span>
                     <span class="n">pp</span><span class="o">.</span><span class="n">Optional</span><span class="p">(</span><span class="n">pp</span><span class="o">.</span><span class="n">Regex</span><span class="p">(</span><span class="s1">&#39;(\ *:\ *&#39;</span> <span class="o">+</span> <span class="n">_</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span><span class="p">)))</span>


<span class="k">def</span> <span class="nf">rangeParseAction</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">tokens</span><span class="p">):</span>

    <span class="n">tokens</span> <span class="o">=</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">debug</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="s1">&#39;_nrange&#39;</span><span class="p">,</span> <span class="n">tokens</span><span class="p">)</span>

    <span class="n">token</span> <span class="o">=</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">sep</span> <span class="o">=</span> <span class="s1">&#39;:&#39;</span> <span class="k">if</span> <span class="s1">&#39;:&#39;</span> <span class="ow">in</span> <span class="n">token</span> <span class="k">else</span> <span class="s1">&#39;to&#39;</span>
    <span class="n">first</span><span class="p">,</span> <span class="n">last</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">sep</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">start</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">first</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="n">start</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">first</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">stop</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">last</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="n">stop</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">last</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">start</span> <span class="o">&gt;</span> <span class="n">stop</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">SelectionError</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="s1">&#39;range start value ({0}) is greater &#39;</span>
                             <span class="s1">&#39;than stop value ({1})&#39;</span>
                             <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">start</span><span class="p">),</span> <span class="nb">repr</span><span class="p">(</span><span class="n">stop</span><span class="p">)))</span>
    <span class="k">elif</span> <span class="n">start</span> <span class="o">==</span> <span class="n">stop</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">sep</span> <span class="o">==</span> <span class="s1">&#39;:&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SelectionError</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="s1">&#39;range start value ({0}) is greater &#39;</span>
                             <span class="s1">&#39;than or equal to stop value ({1})&#39;</span>
                             <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">start</span><span class="p">),</span> <span class="nb">repr</span><span class="p">(</span><span class="n">stop</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">first</span>

    <span class="k">if</span> <span class="n">sep</span> <span class="o">==</span> <span class="s1">&#39;to&#39;</span><span class="p">:</span>
        <span class="n">comp</span> <span class="o">=</span> <span class="s1">&#39;&lt;=&#39;</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">comp</span> <span class="o">=</span> <span class="s1">&#39;&lt;&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">comp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">:])</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">comp</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">:])</span>
    <span class="k">return</span> <span class="s1">&#39;range&#39;</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">comp</span>

<span class="n">PP_NRANGE</span><span class="o">.</span><span class="n">setParseAction</span><span class="p">(</span><span class="n">rangeParseAction</span><span class="p">)</span>


<span class="n">UNARY</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="s1">&#39;not&#39;</span><span class="p">,</span> <span class="s1">&#39;bonded&#39;</span><span class="p">,</span> <span class="s1">&#39;exbonded&#39;</span><span class="p">,</span> <span class="s1">&#39;within&#39;</span><span class="p">,</span> <span class="s1">&#39;exwithin&#39;</span><span class="p">,</span> <span class="s1">&#39;same&#39;</span><span class="p">])</span>


<div class="viewcode-block" id="Select"><a class="viewcode-back" href="../../../manual/reference/atomic/select.html#prody.atomic.select.Select">[docs]</a><span class="k">class</span> <span class="nc">Select</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Select subsets of atoms based on a selection string.</span>
<span class="sd">    See :mod:`~.atomic.select` module documentation for selection grammar</span>
<span class="sd">    and examples.  This class makes use of pyparsing_ module.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_ag</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_atoms</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_indices</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_n_atoms</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_selstr</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_coords</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_kwargs</span>  <span class="o">=</span> <span class="bp">None</span>
        <span class="c1"># set True when selection string alone cannot reproduce the selection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ss2idx</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_replace</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_parsers</span> <span class="o">=</span> <span class="p">{}</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">_evalmap</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;resnum&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resnum</span><span class="p">,</span> <span class="s1">&#39;resid&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resnum</span><span class="p">,</span>
            <span class="s1">&#39;serial&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_serial</span><span class="p">,</span> <span class="s1">&#39;index&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index</span><span class="p">,</span>
            <span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generic</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generic</span><span class="p">,</span> <span class="s1">&#39;z&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generic</span><span class="p">,</span>
            <span class="s1">&#39;chid&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generic</span><span class="p">,</span> <span class="s1">&#39;secstr&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generic</span><span class="p">,</span>
            <span class="s1">&#39;fragment&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generic</span><span class="p">,</span> <span class="s1">&#39;fragindex&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generic</span><span class="p">,</span>
            <span class="s1">&#39;segment&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generic</span><span class="p">,</span> <span class="s1">&#39;sequence&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sequence</span><span class="p">,</span> <span class="p">}</span>


    <span class="k">def</span> <span class="nf">_reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_ag</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_atoms</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_indices</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_n_atoms</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_coords</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_evalAtoms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atoms</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_atoms</span> <span class="o">=</span> <span class="n">atoms</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ag</span> <span class="o">=</span> <span class="n">atoms</span><span class="o">.</span><span class="n">getAtomGroup</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ag</span> <span class="o">=</span> <span class="n">atoms</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_indices</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_indices</span> <span class="o">=</span> <span class="n">atoms</span><span class="o">.</span><span class="n">_getIndices</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_indices</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">index</span> <span class="o">=</span> <span class="n">atoms</span><span class="o">.</span><span class="n">getIndex</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_atoms</span> <span class="o">=</span> <span class="n">Selection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ag</span><span class="p">,</span> <span class="n">array</span><span class="p">([</span><span class="n">index</span><span class="p">]),</span>
                                    <span class="s1">&#39;index &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">),</span> <span class="n">atoms</span><span class="o">.</span><span class="n">getACSIndex</span><span class="p">())</span>

<div class="viewcode-block" id="Select.select"><a class="viewcode-back" href="../../../manual/reference/atomic/select.html#prody.atomic.select.Select.select">[docs]</a>    <span class="k">def</span> <span class="nf">select</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atoms</span><span class="p">,</span> <span class="n">selstr</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a :class:`.Selection` of atoms matching *selstr*, or</span>
<span class="sd">        **None**, if selection string does not match any atoms.</span>

<span class="sd">        :arg atoms: atoms to be evaluated</span>
<span class="sd">        :type atoms: :class:`.Atomic`</span>

<span class="sd">        :arg selstr: selection string</span>
<span class="sd">        :type selstr: str</span>

<span class="sd">        Note that, if *atoms* is an :class:`.AtomMap` instance, an</span>
<span class="sd">        :class:`.AtomMap` is returned, instead of a a :class:`.Selection`.</span>

<span class="sd">        .. note:</span>

<span class="sd">            * A special case for making atom selections is passing an</span>
<span class="sd">              :class:`.AtomMap` instance as *atoms* argument.  Dummy</span>
<span class="sd">              atoms will not be included in the result, but the order</span>
<span class="sd">              of atoms will be preserved.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_ss2idx</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_replace</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_selstr</span> <span class="o">=</span> <span class="n">selstr</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getIndices</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">selstr</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_kwargs</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">AtomGroup</span><span class="p">):</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indices</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span>

        <span class="n">ag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ag</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">dummies</span> <span class="o">=</span> <span class="n">atoms</span><span class="o">.</span><span class="n">numDummies</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ss2idx</span><span class="p">:</span>
                <span class="n">selstr</span> <span class="o">=</span> <span class="s1">&#39;index {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rangeString</span><span class="p">(</span><span class="n">indices</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_replace</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span> <span class="c1"># PY3K: OK</span>
                        <span class="k">if</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">ag</span> <span class="ow">and</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">selstr</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="n">ag</span><span class="p">:</span>
                                <span class="n">ss</span> <span class="o">=</span> <span class="s1">&#39;all&#39;</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">ss</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">getSelstr</span><span class="p">()</span>
                            <span class="n">selstr</span> <span class="o">=</span> <span class="n">selstr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="s1">&#39;(&#39;</span> <span class="o">+</span> <span class="n">ss</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">AtomPointer</span><span class="p">):</span>
                    <span class="n">selstr</span> <span class="o">=</span> <span class="s1">&#39;({0}) and ({1})&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">selstr</span><span class="p">,</span>
                                                      <span class="n">atoms</span><span class="o">.</span><span class="n">getSelstr</span><span class="p">())</span>

            <span class="k">return</span> <span class="n">Selection</span><span class="p">(</span><span class="n">ag</span><span class="p">,</span> <span class="n">indices</span><span class="p">,</span> <span class="n">selstr</span><span class="p">,</span> <span class="n">atoms</span><span class="o">.</span><span class="n">getACSIndex</span><span class="p">(),</span>
                             <span class="n">unique</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">AtomMap</span><span class="p">(</span><span class="n">ag</span><span class="p">,</span> <span class="n">indices</span><span class="p">,</span> <span class="n">atoms</span><span class="o">.</span><span class="n">getACSIndex</span><span class="p">(),</span> <span class="n">dummies</span><span class="o">=</span><span class="n">dummies</span><span class="p">,</span>
               <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Selection {0} from &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">selstr</span><span class="p">))</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">atoms</span><span class="p">))</span></div>

<div class="viewcode-block" id="Select.getIndices"><a class="viewcode-back" href="../../../manual/reference/atomic/select.html#prody.atomic.select.Select.getIndices">[docs]</a>    <span class="k">def</span> <span class="nf">getIndices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atoms</span><span class="p">,</span> <span class="n">selstr</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns indices of atoms matching *selstr*.  Indices correspond to</span>
<span class="sd">        the order in *atoms* argument.  If *atoms* is a subset of atoms, they</span>
<span class="sd">        should not be used for indexing the corresponding :class:`.AtomGroup`</span>
<span class="sd">        instance.&quot;&quot;&quot;</span>

        <span class="n">ss</span> <span class="o">=</span> <span class="n">selstr</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ss</span><span class="o">.</span><span class="n">split</span><span class="p">())</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">ss</span><span class="o">.</span><span class="n">isalnum</span><span class="p">()</span> <span class="ow">and</span> <span class="n">ss</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">MACROS</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_evalAtoms</span><span class="p">(</span><span class="n">atoms</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ss</span> <span class="o">==</span> <span class="s1">&#39;none&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">array</span><span class="p">([])</span>
            <span class="k">elif</span> <span class="n">ss</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">arange</span><span class="p">(</span><span class="n">atoms</span><span class="o">.</span><span class="n">numAtoms</span><span class="p">())</span>
            <span class="k">elif</span> <span class="n">atoms</span><span class="o">.</span><span class="n">isFlagLabel</span><span class="p">(</span><span class="n">ss</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">atoms</span><span class="o">.</span><span class="n">_getFlags</span><span class="p">(</span><span class="n">ss</span><span class="p">)</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">atoms</span><span class="o">.</span><span class="n">isDataLabel</span><span class="p">(</span><span class="n">ss</span><span class="p">)</span> <span class="ow">or</span> <span class="n">ss</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evalmap</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">SelectionError</span><span class="p">(</span><span class="n">selstr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;must be followed by values&#39;</span><span class="p">,</span>
                                     <span class="p">[</span><span class="n">ss</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">SelectionError</span><span class="p">(</span><span class="n">selstr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;is not a valid selection &#39;</span>
                                     <span class="s1">&#39;string&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">ss</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">torf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getBoolArray</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">selstr</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">torf</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span></div>

<div class="viewcode-block" id="Select.getBoolArray"><a class="viewcode-back" href="../../../manual/reference/atomic/select.html#prody.atomic.select.Select.getBoolArray">[docs]</a>    <span class="k">def</span> <span class="nf">getBoolArray</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atoms</span><span class="p">,</span> <span class="n">selstr</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a boolean array with **True** values for *atoms* matching</span>
<span class="sd">        *selstr*.  The length of the boolean :class:`numpy.ndarray` will be</span>
<span class="sd">        equal to the length of *atoms* argument.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">Atomic</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;atoms must be an Atomic instance, not {0}&#39;</span>
                            <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">atoms</span><span class="p">)))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_reset</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span><span class="o">.</span><span class="n">isalnum</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;{0} is not a valid keyword argument, &#39;</span>
                                  <span class="s1">&#39;keywords must be all alpha numeric &#39;</span>
                                  <span class="s1">&#39;characters&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">key</span><span class="p">)))</span>
            <span class="k">if</span> <span class="n">isReserved</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
                <span class="n">loc</span> <span class="o">=</span> <span class="n">selstr</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">loc</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">SelectionError</span><span class="p">(</span><span class="n">selstr</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="s1">&#39;{0} is a reserved &#39;</span>
                                <span class="s1">&#39;word and cannot be used as a keyword argument&#39;</span>
                                <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">key</span><span class="p">)))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_n_atoms</span> <span class="o">=</span> <span class="n">atoms</span><span class="o">.</span><span class="n">numAtoms</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_selstr</span> <span class="o">=</span> <span class="n">selstr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>

        <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span> <span class="k">print</span><span class="p">(</span><span class="s1">&#39;getBoolArray&#39;</span><span class="p">,</span> <span class="n">selstr</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_evalAtoms</span><span class="p">(</span><span class="n">atoms</span><span class="p">)</span>

        <span class="n">selstr</span> <span class="o">=</span> <span class="n">selstr</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">selstr</span><span class="o">.</span><span class="n">split</span><span class="p">())</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">selstr</span><span class="o">.</span><span class="n">isalnum</span><span class="p">()</span> <span class="ow">and</span>
            <span class="n">selstr</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">MACROS</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">selstr</span> <span class="o">==</span> <span class="s1">&#39;none&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">zeros</span><span class="p">(</span><span class="n">atoms</span><span class="o">.</span><span class="n">numAtoms</span><span class="p">(),</span> <span class="nb">bool</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">selstr</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">ones</span><span class="p">(</span><span class="n">atoms</span><span class="o">.</span><span class="n">numAtoms</span><span class="p">(),</span> <span class="nb">bool</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">atoms</span><span class="o">.</span><span class="n">isFlagLabel</span><span class="p">(</span><span class="n">selstr</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">atoms</span><span class="o">.</span><span class="n">getFlags</span><span class="p">(</span><span class="n">selstr</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">atoms</span><span class="o">.</span><span class="n">isDataLabel</span><span class="p">(</span><span class="n">selstr</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">SelectionError</span><span class="p">(</span><span class="n">selstr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;must be followed by values&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">SelectionError</span><span class="p">(</span><span class="n">selstr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;is not a valid selection or &#39;</span>
                                     <span class="s1">&#39;user data label&#39;</span><span class="p">)</span>

        <span class="n">selstr</span> <span class="o">=</span> <span class="n">replaceMacros</span><span class="p">(</span><span class="n">selstr</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">parser</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getParser</span><span class="p">(</span><span class="n">selstr</span><span class="p">)</span>
            <span class="n">tokens</span> <span class="o">=</span> <span class="n">parser</span><span class="p">(</span><span class="n">selstr</span><span class="p">,</span> <span class="n">parseAll</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">pp</span><span class="o">.</span><span class="n">ParseException</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_parsers</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_parser</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">pass</span>
            <span class="n">which</span> <span class="o">=</span> <span class="n">selstr</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">err</span><span class="o">.</span><span class="n">column</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">which</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">selstr</span><span class="p">[</span><span class="n">which</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;(&#39;</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;an arithmetic, comparison, or logical operator &#39;</span>
                           <span class="s1">&#39;must precede the opening parenthesis&#39;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">selstr</span><span class="p">[</span><span class="n">which</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;)&#39;</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;an arithmetic, comparison, or logical operator &#39;</span>
                           <span class="s1">&#39;must follow the closing parenthesis&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;parsing failed here&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;parsing failed here&#39;</span>

            <span class="k">raise</span> <span class="n">SelectionError</span><span class="p">(</span><span class="n">selstr</span><span class="p">,</span> <span class="n">err</span><span class="o">.</span><span class="n">column</span><span class="p">,</span> <span class="n">msg</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span> <span class="k">print</span><span class="p">(</span><span class="s1">&#39;_evalSelstr&#39;</span><span class="p">,</span> <span class="n">tokens</span><span class="p">)</span>
            <span class="n">torf</span> <span class="o">=</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">torf</span><span class="p">,</span> <span class="n">ndarray</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span> <span class="k">print</span><span class="p">(</span><span class="n">torf</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">SelectionError</span><span class="p">(</span><span class="n">selstr</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">torf</span><span class="o">.</span><span class="n">dtype</span> <span class="o">!=</span> <span class="nb">bool</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s1">&#39;_select torf.dtype&#39;</span><span class="p">,</span> <span class="n">torf</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">torf</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
                                                                   <span class="nb">bool</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">SelectionError</span><span class="p">(</span><span class="n">selstr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;_select&#39;</span><span class="p">,</span> <span class="n">torf</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">torf</span></div>

    <span class="k">def</span> <span class="nf">_getParser</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">selstr</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns an efficient parser that can handle *selstr*.&quot;&quot;&quot;</span>

        <span class="n">alnum</span> <span class="o">=</span> <span class="n">selstr</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="n">selstr</span>
        <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">selstr</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ch</span><span class="o">.</span><span class="n">isalnum</span><span class="p">():</span> <span class="n">alnum</span> <span class="o">=</span> <span class="n">alnum</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ch</span><span class="o">.</span><span class="n">isalpha</span><span class="p">():</span> <span class="n">alpha</span> <span class="o">=</span> <span class="n">alpha</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span>
        <span class="n">items</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">alnum</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
        <span class="n">chars</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">selstr</span><span class="p">)</span>


        <span class="n">funcs</span> <span class="o">=</span> <span class="mi">4</span> <span class="k">if</span> <span class="n">items</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">FUNCNAMES</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="n">opers</span> <span class="o">=</span> <span class="mi">2</span> <span class="k">if</span> <span class="n">chars</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">OPERATORS</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="n">logic</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="s1">&#39;or&#39;</span> <span class="ow">in</span> <span class="n">items</span> <span class="ow">or</span> <span class="s1">&#39;(&#39;</span> <span class="ow">in</span> <span class="n">chars</span> <span class="k">else</span> <span class="mi">0</span>

        <span class="n">schars</span> <span class="o">=</span> <span class="mi">8</span> <span class="k">if</span> <span class="s1">&#39;`&#39;</span> <span class="ow">in</span> <span class="n">chars</span> <span class="ow">and</span> <span class="n">RE_SCHARS</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">selstr</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="n">regexp</span> <span class="o">=</span> <span class="mi">16</span> <span class="k">if</span> <span class="s1">&#39;&quot;&#39;</span> <span class="ow">in</span> <span class="n">chars</span> <span class="ow">and</span> <span class="n">RE_REGEXP</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">selstr</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="n">nrange</span> <span class="o">=</span> <span class="mi">32</span> <span class="k">if</span> <span class="p">((</span><span class="s1">&#39;:&#39;</span> <span class="ow">in</span> <span class="n">chars</span> <span class="ow">or</span> <span class="s1">&#39; to &#39;</span> <span class="ow">in</span> <span class="n">alpha</span><span class="p">)</span> <span class="ow">and</span>
                        <span class="n">RE_NRANGE</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">selstr</span><span class="p">))</span> <span class="k">else</span> <span class="mi">0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_parser</span> <span class="o">=</span> <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">logic</span> <span class="o">+</span> <span class="n">opers</span> <span class="o">+</span> <span class="n">funcs</span><span class="p">,</span>
                              <span class="n">logic</span> <span class="o">+</span> <span class="n">funcs</span> <span class="o">+</span> <span class="n">schars</span> <span class="o">+</span> <span class="n">regexp</span> <span class="o">+</span> <span class="n">nrange</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_noParser</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parsers</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">parseString</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">pass</span>


        <span class="n">word</span> <span class="o">=</span> <span class="o">~</span><span class="n">AND</span> <span class="o">+</span> <span class="o">~</span><span class="n">OR</span>

        <span class="n">oplist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">funcs</span><span class="p">:</span>
            <span class="n">oplist</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">FUNCNAMES_OPLIST</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">pp</span><span class="o">.</span><span class="n">opAssoc</span><span class="o">.</span><span class="n">RIGHT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_func</span><span class="p">))</span>
            <span class="c1"># following causes 20% slow down</span>
            <span class="c1">#word += FUNCNAMES_EXPR</span>

        <span class="k">if</span> <span class="n">funcs</span> <span class="ow">or</span> <span class="n">opers</span><span class="p">:</span>
            <span class="n">oplist</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
                <span class="p">(</span><span class="n">pp</span><span class="o">.</span><span class="n">oneOf</span><span class="p">(</span><span class="s1">&#39;+ -&#39;</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">pp</span><span class="o">.</span><span class="n">opAssoc</span><span class="o">.</span><span class="n">RIGHT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sign</span><span class="p">),</span>
                <span class="p">(</span><span class="n">pp</span><span class="o">.</span><span class="n">oneOf</span><span class="p">(</span><span class="s1">&#39;** ^&#39;</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="n">pp</span><span class="o">.</span><span class="n">opAssoc</span><span class="o">.</span><span class="n">LEFT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pow</span><span class="p">),</span>
                <span class="p">(</span><span class="n">pp</span><span class="o">.</span><span class="n">oneOf</span><span class="p">(</span><span class="s1">&#39;* / %&#39;</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="n">pp</span><span class="o">.</span><span class="n">opAssoc</span><span class="o">.</span><span class="n">LEFT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_binop</span><span class="p">),</span>
                <span class="p">(</span><span class="n">pp</span><span class="o">.</span><span class="n">oneOf</span><span class="p">(</span><span class="s1">&#39;+ -&#39;</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="n">pp</span><span class="o">.</span><span class="n">opAssoc</span><span class="o">.</span><span class="n">LEFT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_binop</span><span class="p">),</span>
                <span class="p">(</span><span class="n">pp</span><span class="o">.</span><span class="n">oneOf</span><span class="p">(</span><span class="s1">&#39;&lt; &gt; &lt;= &gt;= == = !=&#39;</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="n">pp</span><span class="o">.</span><span class="n">opAssoc</span><span class="o">.</span><span class="n">LEFT</span><span class="p">,</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">_comp</span><span class="p">)])</span>

        <span class="n">oplist</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
          <span class="p">(</span><span class="n">pp</span><span class="o">.</span><span class="n">Optional</span><span class="p">(</span><span class="n">AND</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="n">pp</span><span class="o">.</span><span class="n">opAssoc</span><span class="o">.</span><span class="n">LEFT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_and</span><span class="p">),</span>
          <span class="p">(</span><span class="n">OR</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">pp</span><span class="o">.</span><span class="n">opAssoc</span><span class="o">.</span><span class="n">LEFT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_or</span><span class="p">)])</span>

        <span class="n">word</span> <span class="o">+=</span> <span class="n">WORD</span>

        <span class="n">expr</span> <span class="o">=</span> <span class="n">word</span>
        <span class="k">if</span> <span class="n">schars</span><span class="p">:</span> <span class="n">expr</span> <span class="o">=</span> <span class="n">PP_SCHARS</span> <span class="o">|</span> <span class="n">expr</span>
        <span class="k">if</span> <span class="n">regexp</span><span class="p">:</span> <span class="n">expr</span> <span class="o">=</span> <span class="n">PP_REGEXP</span> <span class="o">|</span> <span class="n">expr</span>
        <span class="k">if</span> <span class="n">nrange</span><span class="p">:</span> <span class="n">expr</span> <span class="o">=</span> <span class="n">PP_NRANGE</span> <span class="o">|</span> <span class="n">expr</span>

        <span class="n">parser</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">operatorPrecedence</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">oplist</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">setParseAction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_default</span><span class="p">)</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">leaveWhitespace</span><span class="p">()</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">enablePackrat</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parsers</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">parser</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">oplist</span>
        <span class="k">return</span> <span class="n">parser</span><span class="o">.</span><span class="n">parseString</span>

    <span class="k">def</span> <span class="nf">_noParser</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">selstr</span><span class="p">,</span> <span class="n">parseAll</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>

        <span class="n">debug</span><span class="p">(</span><span class="n">selstr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;_noParser&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_default</span><span class="p">(</span><span class="n">selstr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">selstr</span><span class="o">.</span><span class="n">split</span><span class="p">())]</span>

    <span class="k">def</span> <span class="nf">_getZeros</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subset</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a bool array with zero elements.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">subset</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_atoms</span><span class="o">.</span><span class="n">numAtoms</span><span class="p">(),</span> <span class="nb">bool</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">subset</span><span class="p">),</span> <span class="nb">bool</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_default</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">tokens</span><span class="p">):</span>

        <span class="n">debug</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="s1">&#39;_default&#39;</span><span class="p">,</span> <span class="n">tokens</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">NUMB</span><span class="p">:</span> <span class="k">return</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">torf</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_eval</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">tokens</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">torf</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_and2</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">tokens</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">err</span><span class="p">:</span> <span class="k">raise</span> <span class="n">err</span>
        <span class="k">return</span> <span class="n">torf</span>


    <span class="k">def</span> <span class="nf">_eval</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">tokens</span><span class="p">,</span> <span class="n">subset</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="n">debug</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="s1">&#39;_eval&#39;</span><span class="p">,</span> <span class="n">tokens</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">NUMB</span><span class="p">:</span> <span class="k">return</span>
        <span class="c1">#if isinstance(tokens, ndarray):</span>
        <span class="c1">#    return tokens</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>

            <span class="n">token</span> <span class="o">=</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">dtype</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">dtype</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">token</span><span class="p">,</span> <span class="bp">False</span>

            <span class="k">if</span> <span class="n">token</span> <span class="o">==</span> <span class="s1">&#39;none&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_atoms</span> <span class="k">if</span> <span class="n">subset</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="n">subset</span><span class="p">),</span>
                              <span class="nb">bool</span><span class="p">),</span> <span class="bp">False</span>
            <span class="k">elif</span> <span class="n">token</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_n_atoms</span> <span class="k">if</span> <span class="n">subset</span> <span class="ow">is</span> <span class="bp">None</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="n">subset</span><span class="p">),</span>
                            <span class="nb">bool</span><span class="p">),</span> <span class="bp">False</span>

            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_atoms</span><span class="o">.</span><span class="n">isFlagLabel</span><span class="p">(</span><span class="n">token</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getFlags</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">subset</span><span class="p">),</span> <span class="bp">False</span>

            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_atoms</span><span class="o">.</span><span class="n">isDataLabel</span><span class="p">(</span><span class="n">token</span><span class="p">):</span>
                <span class="n">data</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getData</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">subset</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="bp">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">None</span><span class="p">,</span> <span class="n">SelectionError</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="s1">&#39;subset??&#39;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">data</span><span class="p">[</span><span class="n">subset</span><span class="p">],</span> <span class="bp">False</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">arg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kwargs</span><span class="p">[</span><span class="n">token</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">token</span><span class="p">),</span> <span class="bp">False</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>

                    <span class="n">data</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getData</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="bp">False</span>

                    <span class="k">if</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">ATOMIC_FIELDS</span><span class="p">:</span>
                        <span class="k">return</span> <span class="bp">None</span><span class="p">,</span> <span class="n">SelectionError</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="s1">&#39;{0} data is &#39;</span>
                            <span class="s1">&#39;not found&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">token</span><span class="p">)),</span> <span class="p">[</span><span class="n">token</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">return</span> <span class="bp">None</span><span class="p">,</span> <span class="n">SelectionError</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="s1">&#39;{0} could &#39;</span>
                            <span class="s1">&#39;not be evaluated&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">token</span><span class="p">)),</span> <span class="p">[</span><span class="n">token</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">arg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ag</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">dummies</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">numDummies</span><span class="p">()</span>
                    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">indices</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">_getIndices</span><span class="p">()</span>
                        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                            <span class="n">indices</span> <span class="o">=</span> <span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ag</span><span class="o">.</span><span class="n">numAtoms</span><span class="p">())</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">dummies</span><span class="p">:</span>
                            <span class="n">indices</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">_getIndices</span><span class="p">()[</span><span class="n">arg</span><span class="o">.</span><span class="n">getFlags</span><span class="p">(</span><span class="s1">&#39;mapped&#39;</span><span class="p">)]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">indices</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">_getIndices</span><span class="p">()</span>

                    <span class="n">torf</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ag</span><span class="o">.</span><span class="n">numAtoms</span><span class="p">(),</span> <span class="nb">bool</span><span class="p">)</span>
                    <span class="n">torf</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indices</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="n">torf</span> <span class="o">=</span> <span class="n">torf</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_indices</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_replace</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="k">return</span> <span class="n">torf</span><span class="p">,</span> <span class="bp">False</span>
                <span class="k">return</span> <span class="n">token</span><span class="p">,</span> <span class="bp">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evalmap</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generic</span><span class="p">)(</span>
                                            <span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">tokens</span><span class="p">,</span> <span class="n">subset</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_getFlags</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">subset</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">subset</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c1"># get a copy to avoid alterations</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_atoms</span><span class="o">.</span><span class="n">getFlags</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_atoms</span><span class="o">.</span><span class="n">_getFlags</span><span class="p">(</span><span class="n">label</span><span class="p">)[</span><span class="n">subset</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_or</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">tokens</span><span class="p">):</span>

        <span class="n">debug</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="s1">&#39;_or&#39;</span><span class="p">,</span> <span class="n">tokens</span><span class="p">)</span>
        <span class="n">tokens</span> <span class="o">=</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">NUMB</span><span class="p">:</span> <span class="k">return</span>

        <span class="n">flags</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">torfs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">evals</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">atoms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_atoms</span>
        <span class="n">isFlagLabel</span> <span class="o">=</span> <span class="n">atoms</span><span class="o">.</span><span class="n">isFlagLabel</span>
        <span class="n">isDataLabel</span> <span class="o">=</span> <span class="n">atoms</span><span class="o">.</span><span class="n">isDataLabel</span>
        <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">:</span>
            <span class="c1"># check whether token is an array to avoid array == str comparison</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">dtype</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">dtype</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">token</span> <span class="o">==</span> <span class="s1">&#39;or&#39;</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">elif</span> <span class="n">isFlagLabel</span><span class="p">(</span><span class="n">token</span><span class="p">):</span>
                    <span class="n">flags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">isDataLabel</span><span class="p">(</span><span class="n">token</span><span class="p">)</span> <span class="ow">or</span> <span class="n">token</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evalmap</span><span class="p">:</span>
                    <span class="n">evals</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
                    <span class="n">evals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">evals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">SelectionError</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">dtype</span> <span class="o">==</span> <span class="nb">bool</span><span class="p">:</span>
                    <span class="n">torfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">evals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">SelectionError</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">)</span>

        <span class="n">torf</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">torfs</span><span class="p">:</span>
            <span class="n">torf</span> <span class="o">=</span> <span class="n">torfs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">while</span> <span class="n">torfs</span><span class="p">:</span>
                <span class="n">ss</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">torf</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ss</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="n">torf</span>
                <span class="n">torf</span><span class="p">[</span><span class="n">ss</span><span class="p">]</span> <span class="o">=</span> <span class="n">torfs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)[</span><span class="n">ss</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">flags</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">torf</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">torf</span> <span class="o">=</span> <span class="n">atoms</span><span class="o">.</span><span class="n">getFlags</span><span class="p">(</span><span class="n">flags</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
            <span class="k">while</span> <span class="n">flags</span><span class="p">:</span>
                <span class="n">ss</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">torf</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ss</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="n">torf</span>
                <span class="n">torf</span><span class="p">[</span><span class="n">ss</span><span class="p">]</span> <span class="o">=</span> <span class="n">atoms</span><span class="o">.</span><span class="n">_getFlags</span><span class="p">(</span><span class="n">flags</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">))[</span><span class="n">ss</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">evals</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">torf</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">tokens</span> <span class="o">=</span> <span class="n">evals</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">first</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">torf</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_eval</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">tokens</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">err</span><span class="p">:</span> <span class="k">raise</span> <span class="n">err</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">dtype</span> <span class="o">=</span> <span class="n">torf</span><span class="o">.</span><span class="n">dtype</span>
                <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">SelectionError</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="s1">&#39;a problem &#39;</span>
                        <span class="s1">&#39;occurred when evaluating token {0}&#39;</span>
                        <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">first</span><span class="p">)),</span> <span class="p">[</span><span class="n">first</span><span class="p">])</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">dtype</span> <span class="o">!=</span> <span class="nb">bool</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">SelectionError</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="s1">&#39;a problem &#39;</span>
                            <span class="s1">&#39;occurred when evaluating token {0}&#39;</span>
                            <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">first</span><span class="p">)),</span> <span class="p">[</span><span class="n">first</span><span class="p">])</span>
            <span class="k">while</span> <span class="n">evals</span><span class="p">:</span>
                <span class="n">ss</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">torf</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ss</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="n">torf</span>
                <span class="n">tokens</span> <span class="o">=</span> <span class="n">evals</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">first</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">arr</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_eval</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">tokens</span><span class="p">,</span> <span class="n">subset</span><span class="o">=</span><span class="n">ss</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">err</span><span class="p">:</span> <span class="k">raise</span> <span class="n">err</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">dtype</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">dtype</span>
                <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">SelectionError</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="s1">&#39;a problem &#39;</span>
                        <span class="s1">&#39;occurred when evaluating token {0}&#39;</span>
                        <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">first</span><span class="p">)),</span> <span class="p">[</span><span class="n">first</span><span class="p">])</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">dtype</span> <span class="o">!=</span> <span class="nb">bool</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">SelectionError</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="s1">&#39;a problem &#39;</span>
                            <span class="s1">&#39;occurred when evaluating token {0}&#39;</span>
                            <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">first</span><span class="p">)),</span> <span class="p">[</span><span class="n">first</span><span class="p">])</span>

                <span class="n">torf</span><span class="p">[</span><span class="n">ss</span><span class="p">]</span> <span class="o">=</span> <span class="n">arr</span>

        <span class="k">return</span> <span class="n">torf</span>

    <span class="k">def</span> <span class="nf">_and</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">tokens</span><span class="p">):</span>

        <span class="n">debug</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="s1">&#39;_and&#39;</span><span class="p">,</span> <span class="n">tokens</span><span class="p">)</span>
        <span class="n">tokens</span> <span class="o">=</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">torf</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_and2</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">tokens</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">err</span><span class="p">:</span> <span class="k">raise</span> <span class="n">err</span>
        <span class="k">return</span> <span class="n">torf</span>

    <span class="k">def</span> <span class="nf">_and2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">tokens</span><span class="p">,</span> <span class="n">subset</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="n">debug</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="s1">&#39;_and2&#39;</span><span class="p">,</span> <span class="n">tokens</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">NUMB</span><span class="p">:</span> <span class="k">return</span>
        
        <span class="n">firsttoken</span> <span class="o">=</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Iterable</span><span class="p">)</span> <span class="k">else</span> <span class="nb">list</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">lasttoken</span> <span class="o">=</span> <span class="n">tokens</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">Iterable</span><span class="p">)</span> <span class="k">else</span> <span class="nb">list</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">firsttoken</span> <span class="o">==</span> <span class="s1">&#39;and&#39;</span> <span class="ow">or</span> <span class="n">lasttoken</span> <span class="o">==</span> <span class="s1">&#39;and&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span><span class="p">,</span> <span class="n">SelectionError</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="s1">&#39;{0} operator must be &#39;</span>
                <span class="s1">&#39;surrounded with arguments&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="s1">&#39;and&#39;</span><span class="p">)),</span> <span class="p">[</span><span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>

        <span class="n">flags</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">torfs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">evals</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">unary</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">atoms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_atoms</span>
        <span class="n">isFlagLabel</span> <span class="o">=</span> <span class="n">atoms</span><span class="o">.</span><span class="n">isFlagLabel</span>
        <span class="n">isDataLabel</span> <span class="o">=</span> <span class="n">atoms</span><span class="o">.</span><span class="n">isDataLabel</span>
        <span class="n">append</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">wasand</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">while</span> <span class="n">tokens</span><span class="p">:</span>
            <span class="c1"># check whether token is an array to avoid array == str comparison</span>
            <span class="n">token</span> <span class="o">=</span> <span class="n">tokens</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">dtype</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">dtype</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">token</span> <span class="o">==</span> <span class="s1">&#39;and&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">wasand</span><span class="p">:</span>
                        <span class="k">return</span> <span class="bp">None</span><span class="p">,</span> <span class="n">SelectionError</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="s1">&#39;incorrect use &#39;</span>
                            <span class="s1">&#39;of `and` operator, expected {0}&#39;</span>
                            <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="s1">&#39;and ... and&#39;</span><span class="p">)),</span> <span class="p">[</span><span class="s1">&#39;and&#39;</span><span class="p">,</span> <span class="s1">&#39;and&#39;</span><span class="p">])</span>
                    <span class="n">append</span> <span class="o">=</span> <span class="bp">None</span>
                    <span class="n">wasand</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="k">continue</span>

                <span class="k">elif</span> <span class="n">isFlagLabel</span><span class="p">(</span><span class="n">token</span><span class="p">):</span>
                    <span class="n">flags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
                    <span class="n">append</span> <span class="o">=</span> <span class="bp">None</span>

                <span class="k">elif</span> <span class="p">(</span><span class="n">isDataLabel</span><span class="p">(</span><span class="n">token</span><span class="p">)</span> <span class="ow">or</span> <span class="n">token</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evalmap</span> <span class="ow">or</span>
                      <span class="n">token</span> <span class="ow">in</span> <span class="n">ATOMIC_FIELDS</span><span class="p">):</span>
                    <span class="c1"># not evals, must start a new list</span>
                    <span class="c1"># last evals list must have more than one values</span>
                    <span class="c1">#</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">evals</span><span class="p">:</span>
                        <span class="n">evals</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
                        <span class="n">append</span> <span class="o">=</span> <span class="n">evals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span>
                    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">evals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">XYZ</span><span class="p">:</span>
                            <span class="k">pass</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">return</span> <span class="bp">None</span><span class="p">,</span> <span class="n">SelectionError</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="s1">&#39;{0} &#39;</span>
                                <span class="s1">&#39;must be followed by values&#39;</span>
                                <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">evals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span> <span class="p">[</span><span class="n">evals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]])</span>
                    <span class="k">elif</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">XYZ</span><span class="p">:</span>
                        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">tokens</span> <span class="ow">or</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evalmap</span> <span class="ow">or</span>
                              <span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">ATOMIC_FIELDS</span> <span class="ow">or</span>
                              <span class="n">isDataLabel</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">or</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;and&#39;</span><span class="p">):</span>
                            <span class="k">pass</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="nb">float</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                            <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                                <span class="k">pass</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">evals</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
                                <span class="n">append</span> <span class="o">=</span> <span class="n">evals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span>
                    <span class="k">elif</span> <span class="ow">not</span> <span class="n">tokens</span><span class="p">:</span>
                        <span class="k">return</span> <span class="bp">None</span><span class="p">,</span> <span class="n">SelectionError</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="s1">&#39;{0} &#39;</span>
                            <span class="s1">&#39;must be followed by values&#39;</span>
                            <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">token</span><span class="p">),</span> <span class="p">[</span><span class="n">token</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">evals</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
                        <span class="n">append</span> <span class="o">=</span> <span class="n">evals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span>
                    <span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>

                <span class="k">elif</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">UNARY</span><span class="p">:</span>
                    <span class="n">unary</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
                    <span class="n">append</span> <span class="o">=</span> <span class="n">unary</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span>

                    <span class="k">if</span> <span class="n">token</span> <span class="o">==</span> <span class="s1">&#39;not&#39;</span><span class="p">:</span>
                        <span class="n">append</span><span class="p">((</span><span class="n">token</span><span class="p">,))</span>

                    <span class="k">elif</span> <span class="n">token</span> <span class="o">==</span> <span class="s1">&#39;same&#39;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span> <span class="ow">or</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;as&#39;</span><span class="p">:</span>
                            <span class="k">return</span> <span class="bp">None</span><span class="p">,</span> <span class="n">SelectionError</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="s1">&#39;incorrect &#39;</span>
                                <span class="s1">&#39;use of `same as` statement, expected {0}&#39;</span>
                                <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;same entity as ...&#39;</span><span class="p">),</span> <span class="p">[</span><span class="n">token</span><span class="p">])</span>
                        <span class="n">append</span><span class="p">((</span><span class="n">token</span><span class="p">,</span> <span class="n">tokens</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">tokens</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)))</span>

                    <span class="k">elif</span> <span class="n">token</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;within&#39;</span><span class="p">):</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span> <span class="ow">or</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;of&#39;</span><span class="p">:</span>
                            <span class="k">return</span> <span class="bp">None</span><span class="p">,</span> <span class="n">SelectionError</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="s1">&#39;incorrect &#39;</span>
                                <span class="s1">&#39;use of `within` statement, expected {0}&#39;</span>
                                <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;[ex]within x.y of ...&#39;</span><span class="p">),</span> <span class="p">[</span><span class="n">token</span><span class="p">])</span>
                        <span class="n">append</span><span class="p">((</span><span class="n">token</span><span class="p">,</span> <span class="n">tokens</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">tokens</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)))</span>

                    <span class="k">elif</span> <span class="n">token</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;bonded&#39;</span><span class="p">):</span>
                        <span class="n">token2</span> <span class="o">=</span> <span class="n">tokens</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">token2</span> <span class="o">==</span> <span class="s1">&#39;to&#39;</span><span class="p">)):</span>
                            <span class="k">return</span> <span class="bp">None</span><span class="p">,</span> <span class="n">SelectionError</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="s1">&#39;incorrect &#39;</span>
                                <span class="s1">&#39;use of `bonded` statement, expected {0}&#39;</span>
                                <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;[ex]bonded [n] to ...&#39;</span><span class="p">),</span> <span class="p">[</span><span class="n">token2</span><span class="p">])</span>
                        <span class="k">if</span> <span class="n">token2</span> <span class="o">==</span> <span class="s1">&#39;to&#39;</span><span class="p">:</span>
                            <span class="n">append</span><span class="p">((</span><span class="n">token</span><span class="p">,</span> <span class="s1">&#39;to&#39;</span><span class="p">))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">append</span><span class="p">((</span><span class="n">token</span><span class="p">,</span> <span class="n">token2</span><span class="p">,</span> <span class="n">tokens</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)))</span>

                    <span class="n">anyargs</span> <span class="o">=</span> <span class="bp">False</span>
                    <span class="k">while</span> <span class="n">tokens</span><span class="p">:</span>
                        <span class="nb">next</span> <span class="o">=</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">dtype</span> <span class="o">=</span> <span class="nb">next</span><span class="o">.</span><span class="n">dtype</span>
                        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                            <span class="n">append</span><span class="p">(</span><span class="n">tokens</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
                            <span class="k">if</span> <span class="nb">next</span> <span class="o">==</span> <span class="s1">&#39;and&#39;</span> <span class="ow">or</span> <span class="n">isFlagLabel</span><span class="p">(</span><span class="nb">next</span><span class="p">):</span>
                                <span class="k">break</span>
                            <span class="k">if</span> <span class="n">isDataLabel</span><span class="p">(</span><span class="nb">next</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">next</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_evalmap</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">anyargs</span><span class="p">:</span>
                                    <span class="k">break</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">anyargs</span> <span class="o">=</span> <span class="bp">True</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">append</span><span class="p">(</span><span class="n">tokens</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
                            <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                        <span class="k">return</span> <span class="bp">None</span><span class="p">,</span> <span class="n">SelectionError</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="s1">&#39;a problem &#39;</span>
                                    <span class="s1">&#39;occurred when evaluation token {0}&#39;</span>
                                    <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">token</span><span class="p">)),</span> <span class="p">[</span><span class="n">token</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">dtype</span> <span class="o">==</span> <span class="nb">bool</span><span class="p">:</span>
                    <span class="n">torfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">None</span><span class="p">,</span> <span class="n">SelectionError</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="s1">&#39;a problem &#39;</span>
                                <span class="s1">&#39;occurred when evaluation token {0}&#39;</span>
                                <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">token</span><span class="p">)),</span> <span class="p">[</span><span class="n">token</span><span class="p">])</span>
            <span class="n">wasand</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">torf</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">if</span> <span class="n">torfs</span><span class="p">:</span>
            <span class="n">torf</span> <span class="o">=</span> <span class="n">torfs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

            <span class="k">while</span> <span class="n">torfs</span><span class="p">:</span>
                <span class="n">ss</span> <span class="o">=</span> <span class="n">torf</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ss</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="n">torf</span><span class="p">,</span> <span class="bp">False</span>
                <span class="n">torf</span><span class="p">[</span><span class="n">ss</span><span class="p">]</span> <span class="o">=</span> <span class="n">torfs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)[</span><span class="n">ss</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">flags</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">torf</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">torf</span> <span class="o">=</span> <span class="n">atoms</span><span class="o">.</span><span class="n">getFlags</span><span class="p">(</span><span class="n">flags</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>

            <span class="k">while</span> <span class="n">flags</span><span class="p">:</span>
                <span class="n">ss</span> <span class="o">=</span> <span class="n">torf</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ss</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="n">torf</span><span class="p">,</span> <span class="bp">False</span>
                <span class="n">torf</span><span class="p">[</span><span class="n">ss</span><span class="p">]</span> <span class="o">=</span> <span class="n">atoms</span><span class="o">.</span><span class="n">_getFlags</span><span class="p">(</span><span class="n">flags</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">))[</span><span class="n">ss</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">unary</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">torf</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">torf</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unary</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">unary</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">err</span><span class="p">:</span> <span class="k">return</span> <span class="bp">None</span><span class="p">,</span> <span class="n">err</span>

            <span class="k">while</span> <span class="n">unary</span><span class="p">:</span>
                <span class="n">ss</span> <span class="o">=</span> <span class="n">torf</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ss</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="n">torf</span><span class="p">,</span> <span class="bp">False</span>
                <span class="n">arr</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unary</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">unary</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">err</span><span class="p">:</span> <span class="k">return</span> <span class="bp">None</span><span class="p">,</span> <span class="n">err</span>
                <span class="n">torf</span><span class="p">[</span><span class="n">ss</span><span class="p">]</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="n">ss</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">evals</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">torf</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">tokens</span> <span class="o">=</span> <span class="n">evals</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">first</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">torf</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_eval</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">tokens</span><span class="p">,</span> <span class="n">subset</span><span class="o">=</span><span class="n">subset</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">err</span><span class="p">:</span> <span class="k">return</span> <span class="bp">None</span><span class="p">,</span> <span class="n">err</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">dtype</span> <span class="o">=</span> <span class="n">torf</span><span class="o">.</span><span class="n">dtype</span>
                <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">None</span><span class="p">,</span> <span class="n">SelectionError</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="s1">&#39;a problem &#39;</span>
                        <span class="s1">&#39;occurred when evaluating token {0}&#39;</span>
                        <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">first</span><span class="p">)),</span> <span class="p">[</span><span class="n">first</span><span class="p">])</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">dtype</span> <span class="o">!=</span> <span class="nb">bool</span><span class="p">:</span>
                        <span class="k">return</span> <span class="bp">None</span><span class="p">,</span> <span class="n">SelectionError</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="s1">&#39;a problem &#39;</span>
                            <span class="s1">&#39;occurred when evaluating token {0}&#39;</span>
                            <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">first</span><span class="p">)),</span> <span class="p">[</span><span class="n">first</span><span class="p">])</span>
            <span class="k">while</span> <span class="n">evals</span><span class="p">:</span>
                <span class="n">ss</span> <span class="o">=</span> <span class="n">torf</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ss</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="n">torf</span><span class="p">,</span> <span class="bp">False</span>
                <span class="n">tokens</span> <span class="o">=</span> <span class="n">evals</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">first</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">arr</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_eval</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">tokens</span><span class="p">,</span> <span class="n">subset</span><span class="o">=</span><span class="n">ss</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">err</span><span class="p">:</span> <span class="k">return</span> <span class="bp">None</span><span class="p">,</span> <span class="n">err</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">dtype</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">dtype</span>
                <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">None</span><span class="p">,</span> <span class="n">SelectionError</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="s1">&#39;a problem &#39;</span>
                        <span class="s1">&#39;occurred when evaluating token {0}&#39;</span>
                        <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">first</span><span class="p">)),</span> <span class="p">[</span><span class="n">first</span><span class="p">])</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">dtype</span> <span class="o">!=</span> <span class="nb">bool</span><span class="p">:</span>
                        <span class="k">return</span> <span class="bp">None</span><span class="p">,</span> <span class="n">SelectionError</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="s1">&#39;a problem &#39;</span>
                            <span class="s1">&#39;occurred when evaluating token {0}&#39;</span>
                            <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">first</span><span class="p">)),</span> <span class="p">[</span><span class="n">first</span><span class="p">])</span>

                <span class="n">torf</span><span class="p">[</span><span class="n">ss</span><span class="p">]</span> <span class="o">=</span> <span class="n">arr</span>

        <span class="c1"># ?? check torf.shape/ndim</span>
        <span class="k">if</span> <span class="n">subset</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">torf</span><span class="p">,</span> <span class="bp">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">torf</span><span class="p">[</span><span class="n">subset</span><span class="p">],</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">_unary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">tokens</span><span class="p">):</span>

        <span class="n">debug</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="s1">&#39;_unary&#39;</span><span class="p">,</span> <span class="n">tokens</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">NUMB</span><span class="p">:</span> <span class="k">return</span>

        <span class="n">what</span> <span class="o">=</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">which</span> <span class="o">=</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">which</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span><span class="p">,</span> <span class="n">SelectionError</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="s1">&#39;{0} must be followed by &#39;</span>
                <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">what</span><span class="p">))),</span> <span class="n">what</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">which</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">which</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_eval</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">which</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">which</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_and2</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">which</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">err</span><span class="p">:</span> <span class="k">raise</span> <span class="n">err</span>

        <span class="n">tokens</span> <span class="o">=</span> <span class="p">[</span><span class="n">what</span><span class="p">,</span> <span class="n">which</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">what</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;not&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_not</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">tokens</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">what</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;same&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sameas</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">tokens</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">what</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;to&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bondedto</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">tokens</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_within</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">tokens</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_not</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">tokens</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Negate selection.&quot;&quot;&quot;</span>

        <span class="n">debug</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="s1">&#39;_not&#39;</span><span class="p">,</span> <span class="n">tokens</span><span class="p">)</span>
        <span class="n">label</span><span class="p">,</span> <span class="n">torf</span> <span class="o">=</span> <span class="n">tokens</span>
        <span class="k">return</span> <span class="n">invert</span><span class="p">(</span><span class="n">torf</span><span class="p">,</span> <span class="n">torf</span><span class="p">),</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">_within</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">tokens</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Perform distance based selection.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span> <span class="k">print</span><span class="p">(</span><span class="s1">&#39;_within&#39;</span><span class="p">,</span> <span class="n">tokens</span><span class="p">)</span>
        <span class="n">label</span><span class="p">,</span> <span class="n">which</span> <span class="o">=</span> <span class="n">tokens</span>
        <span class="n">within</span> <span class="o">=</span> <span class="n">label</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">within</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">within</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span><span class="p">,</span> <span class="n">SelectionError</span><span class="p">(</span><span class="s1">&#39;could not convert {0} in {1} to &#39;</span>
                <span class="s1">&#39;float ({2})&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">within</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">label</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)),</span>
                <span class="p">[</span><span class="n">label</span><span class="p">,</span> <span class="n">within</span><span class="p">])</span>
        <span class="n">exclude</span> <span class="o">=</span> <span class="n">label</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;ex&#39;</span><span class="p">)</span>
        <span class="n">other</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="n">which</span><span class="o">.</span><span class="n">dtype</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">which</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kwargs</span><span class="p">:</span>
                <span class="n">coords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kwargs</span><span class="p">[</span><span class="n">which</span><span class="p">]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">ndim</span><span class="p">,</span> <span class="n">shape</span> <span class="o">=</span> <span class="n">coords</span><span class="o">.</span><span class="n">ndim</span><span class="p">,</span> <span class="n">coords</span><span class="o">.</span><span class="n">shape</span>
                <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">coords</span> <span class="o">=</span> <span class="n">coords</span><span class="o">.</span><span class="n">_getCoords</span><span class="p">()</span>
                    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">coords</span> <span class="o">=</span> <span class="n">coords</span><span class="o">.</span><span class="n">getCoords</span><span class="p">()</span>
                        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                            <span class="k">return</span> <span class="bp">None</span><span class="p">,</span> <span class="n">SelectionError</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span>
                                <span class="s1">&#39;{0} must be a coordinate array or have &#39;</span>
                                <span class="s1">&#39;`getCoords` method&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">which</span><span class="p">)),</span>
                                <span class="p">[</span><span class="n">label</span><span class="p">,</span> <span class="n">which</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">coords</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="k">return</span> <span class="bp">None</span><span class="p">,</span> <span class="n">SelectionError</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span>
                            <span class="s1">&#39;coordinates are not set for {0} ({1})&#39;</span>
                            <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">which</span><span class="p">),</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_kwargs</span><span class="p">[</span><span class="n">which</span><span class="p">])),</span>
                            <span class="p">[</span><span class="n">label</span><span class="p">,</span> <span class="n">which</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">ndim</span><span class="p">,</span> <span class="n">shape</span> <span class="o">=</span> <span class="n">coords</span><span class="o">.</span><span class="n">ndim</span><span class="p">,</span> <span class="n">coords</span><span class="o">.</span><span class="n">shape</span>
                <span class="k">if</span> <span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="n">coords</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="n">coords</span><span class="p">])</span>
                <span class="k">elif</span> <span class="ow">not</span> <span class="p">(</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">):</span>
                    <span class="k">return</span> <span class="bp">None</span><span class="p">,</span> <span class="n">SelectionError</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span>
                        <span class="s1">&#39;{0} must be a coordinate array or have &#39;</span>
                        <span class="s1">&#39;`getCoords` method&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">which</span><span class="p">)),</span>
                        <span class="p">[</span><span class="n">label</span><span class="p">,</span> <span class="n">which</span><span class="p">])</span>
                <span class="n">exclude</span><span class="o">=</span><span class="bp">False</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ss2idx</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="n">which</span> <span class="o">=</span> <span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">coords</span><span class="p">))</span>
                <span class="n">other</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dtype</span> <span class="o">==</span> <span class="nb">bool</span><span class="p">:</span>
                <span class="n">which</span> <span class="o">=</span> <span class="n">which</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">coords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getCoords</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">coords</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">None</span><span class="p">,</span> <span class="n">SelectionError</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="s1">&#39;coordinates are &#39;</span>
                                                <span class="s1">&#39;not set&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">None</span><span class="p">,</span> <span class="n">SelectionError</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="s1">&#39;not understood&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">other</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">which</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">:</span>
            <span class="n">kdtree</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_atoms</span><span class="o">.</span><span class="n">_getKDTree</span><span class="p">()</span>
            <span class="n">get_indices</span> <span class="o">=</span> <span class="n">kdtree</span><span class="o">.</span><span class="n">getIndices</span>
            <span class="n">search</span> <span class="o">=</span> <span class="n">kdtree</span><span class="o">.</span><span class="n">search</span>
            <span class="n">get_count</span> <span class="o">=</span> <span class="n">kdtree</span><span class="o">.</span><span class="n">getCount</span>
            <span class="n">torf</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ag</span><span class="o">.</span><span class="n">numAtoms</span><span class="p">(),</span> <span class="nb">bool</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">which</span><span class="p">:</span>
                <span class="n">search</span><span class="p">(</span><span class="n">within</span><span class="p">,</span> <span class="n">coords</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">get_count</span><span class="p">():</span>
                    <span class="n">torf</span><span class="p">[</span><span class="n">get_indices</span><span class="p">()]</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indices</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">torf</span> <span class="o">=</span> <span class="n">torf</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_indices</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">exclude</span><span class="p">:</span>
                <span class="n">torf</span><span class="p">[</span><span class="n">which</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">n_atoms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ag</span><span class="o">.</span><span class="n">numAtoms</span><span class="p">()</span>
            <span class="n">torf</span> <span class="o">=</span> <span class="n">ones</span><span class="p">(</span><span class="n">n_atoms</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span>
            <span class="n">torf</span><span class="p">[</span><span class="n">which</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="n">check</span> <span class="o">=</span> <span class="n">torf</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">torf</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="n">n_atoms</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span>

            <span class="n">cxyz</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[</span><span class="n">check</span><span class="p">]</span>
            <span class="n">kdtree</span> <span class="o">=</span> <span class="n">KDTree</span><span class="p">(</span><span class="n">coords</span><span class="p">[</span><span class="n">which</span><span class="p">])</span>
            <span class="n">search</span> <span class="o">=</span> <span class="n">kdtree</span><span class="o">.</span><span class="n">search</span>
            <span class="n">get_count</span> <span class="o">=</span> <span class="n">kdtree</span><span class="o">.</span><span class="n">getCount</span>
            <span class="n">select</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">append</span> <span class="o">=</span> <span class="n">select</span><span class="o">.</span><span class="n">append</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">xyz</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cxyz</span><span class="p">):</span>
                <span class="n">search</span><span class="p">(</span><span class="n">within</span><span class="p">,</span> <span class="n">xyz</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">get_count</span><span class="p">():</span>
                    <span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

            <span class="n">torf</span><span class="p">[</span><span class="n">check</span><span class="p">[</span><span class="n">select</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">exclude</span><span class="p">:</span>
                <span class="n">torf</span><span class="p">[</span><span class="n">which</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="k">return</span> <span class="n">torf</span><span class="p">,</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">_sameas</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">tokens</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Evaluate ``&#39;same entity as ...&#39;`` expression.&quot;&quot;&quot;</span>

        <span class="n">debug</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="s1">&#39;_sameas&#39;</span><span class="p">,</span> <span class="n">tokens</span><span class="p">)</span>
        <span class="n">label</span><span class="p">,</span> <span class="n">which</span> <span class="o">=</span> <span class="n">tokens</span>
        <span class="n">what</span> <span class="o">=</span> <span class="n">label</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">SAMEAS_MAP</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">what</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">index</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span><span class="p">,</span> <span class="n">SelectionError</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="s1">&#39;entity in &quot;same ... as&quot; &#39;</span>
                <span class="s1">&#39;must be one of &quot;chain&quot;, &quot;residue&quot;, &quot;segment&quot;, or &quot;fragment&quot;,&#39;</span>
                <span class="s1">&#39; not {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">what</span><span class="p">)),</span> <span class="p">[</span><span class="n">label</span><span class="p">])</span>

        <span class="n">indices</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getData</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
        <span class="n">iset</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">indices</span><span class="p">[</span><span class="n">which</span><span class="p">])</span>
        <span class="n">torf</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="n">i</span> <span class="ow">in</span> <span class="n">iset</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">],</span> <span class="nb">bool</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">torf</span><span class="p">,</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">_bondedto</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">tokens</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Expand selection to immediately bonded atoms.&quot;&quot;&quot;</span>

        <span class="n">debug</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="s1">&#39;_bondedto&#39;</span><span class="p">,</span> <span class="n">tokens</span><span class="p">)</span>
        <span class="n">label</span><span class="p">,</span> <span class="n">torf</span> <span class="o">=</span> <span class="n">tokens</span>
        <span class="n">token</span> <span class="o">=</span> <span class="n">label</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">token</span> <span class="o">==</span> <span class="s1">&#39;to&#39;</span><span class="p">:</span>
            <span class="n">repeat</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">repeat</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">None</span><span class="p">,</span> <span class="n">SelectionError</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="s1">&#39;{0} in {0} could not &#39;</span>
                    <span class="s1">&#39;be converted to an integer&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">label</span><span class="p">)),</span>
                    <span class="p">[</span><span class="n">label</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="n">token</span><span class="p">)</span> <span class="o">!=</span> <span class="n">repeat</span><span class="p">:</span>
                    <span class="n">SelectionWarning</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="s1">&#39;number in {0} should be an &#39;</span>
                        <span class="s1">&#39;integer&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">label</span><span class="p">)),</span> <span class="p">[</span><span class="n">label</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">repeat</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">SelectionWarning</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="s1">&#39;number in {0} should be a &#39;</span>
                    <span class="s1">&#39;positive integer&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">label</span><span class="p">)),</span> <span class="p">[</span><span class="n">label</span><span class="p">])</span>
                <span class="k">return</span> <span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_atoms</span><span class="o">.</span><span class="n">numAtoms</span><span class="p">(),</span> <span class="nb">bool</span><span class="p">),</span> <span class="bp">False</span>

        <span class="n">bmap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ag</span><span class="o">.</span><span class="n">_bmap</span>
        <span class="k">if</span> <span class="n">bmap</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span><span class="p">,</span> <span class="n">SelectionError</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="s1">&#39;bonds are not set&#39;</span><span class="p">,</span>
                                        <span class="p">[</span><span class="n">label</span><span class="p">])</span>
        <span class="n">which</span> <span class="o">=</span> <span class="n">torf</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">which</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">torf</span><span class="p">,</span> <span class="bp">False</span>

        <span class="n">indices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indices</span>
        <span class="k">if</span> <span class="n">indices</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">bmap</span> <span class="o">=</span> <span class="n">bmap</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span>
        <span class="n">n_atoms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ag</span><span class="o">.</span><span class="n">numAtoms</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">repeat</span><span class="p">):</span>
            <span class="n">torf</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="n">n_atoms</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span>
            <span class="n">bonded</span> <span class="o">=</span> <span class="n">unique</span><span class="p">(</span><span class="n">bmap</span><span class="p">[</span><span class="n">which</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">bonded</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">torf</span><span class="p">[</span><span class="n">bonded</span><span class="p">[</span><span class="mi">1</span><span class="p">:]]</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">torf</span><span class="p">[</span><span class="n">bonded</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">if</span> <span class="n">indices</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">torf</span> <span class="o">=</span> <span class="n">torf</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">label</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;ex&#39;</span><span class="p">):</span>
                <span class="n">torf</span><span class="p">[</span><span class="n">which</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">torf</span><span class="p">[</span><span class="n">which</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">repeat</span><span class="p">:</span>
                <span class="n">which</span> <span class="o">=</span> <span class="n">torf</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">torf</span><span class="p">,</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">_getNumeric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns numeric data or a number.&quot;&quot;&quot;</span>

        <span class="n">debug</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="s1">&#39;_getNumeric&#39;</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span>

        <span class="c1"># arg may be an array, a string, or a regular expression</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">dtype</span><span class="p">,</span> <span class="n">ndim</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">arg</span><span class="o">.</span><span class="n">ndim</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># i don&#39;t expect that a string array may show up</span>
            <span class="k">if</span> <span class="n">dtype</span> <span class="o">==</span> <span class="nb">bool</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">None</span><span class="p">,</span> <span class="n">SelectionError</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="s1">&#39;operands and function &#39;</span>
                    <span class="s1">&#39;arguments must be numbers or numeric data labels&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">arg</span><span class="p">,</span> <span class="bp">False</span>

        <span class="c1"># no regular expressions</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">pattern</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">pattern</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span><span class="p">,</span> <span class="n">SelectionError</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">sel</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">loc</span><span class="p">),</span>
               <span class="s1">&#39;operands and function arguments cannot be regular expressions&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">XYZ2INDEX</span><span class="p">:</span>
            <span class="n">coords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getCoords</span><span class="p">()</span> <span class="c1"># how about atoms._getCoords() ?</span>
            <span class="k">if</span> <span class="n">coords</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">None</span><span class="p">,</span> <span class="n">SelectionError</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span>
                    <span class="s1">&#39;coordinates are not set&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">copy</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">coords</span><span class="p">[:,</span> <span class="n">XYZ2INDEX</span><span class="p">[</span><span class="n">arg</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="bp">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">coords</span><span class="p">[:,</span> <span class="n">XYZ2INDEX</span><span class="p">[</span><span class="n">arg</span><span class="p">]],</span> <span class="bp">False</span>
        <span class="n">arg</span> <span class="o">=</span> <span class="n">FIELDS_SYNONYMS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">copy</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_atoms</span><span class="o">.</span><span class="n">getData</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_atoms</span><span class="o">.</span><span class="n">_getData</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span><span class="p">,</span> <span class="n">SelectionError</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="s1">&#39;following exception &#39;</span>
                        <span class="s1">&#39;occurred when evaluating {0}: {1}&#39;</span>
                        <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">arg</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)))</span>

        <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">char</span> <span class="ow">in</span> <span class="s1">&#39;US&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">None</span><span class="p">,</span> <span class="n">SelectionError</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="s1">&#39;{0} is not a numeric &#39;</span>
                        <span class="s1">&#39;data label&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">arg</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="bp">False</span>

        <span class="k">if</span> <span class="n">arg</span> <span class="o">==</span> <span class="s1">&#39;index&#39;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">copy</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_atoms</span><span class="o">.</span><span class="n">getIndices</span><span class="p">(),</span> <span class="bp">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_atoms</span><span class="o">.</span><span class="n">_getIndices</span><span class="p">(),</span> <span class="bp">False</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_atoms</span><span class="o">.</span><span class="n">numAtoms</span><span class="p">()),</span> <span class="bp">False</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">arg</span><span class="p">),</span> <span class="bp">False</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span><span class="p">,</span> <span class="n">SelectionError</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="s1">&#39;{0} is not a number or a &#39;</span>
                    <span class="s1">&#39;numeric data label&#39;</span>
                    <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">arg</span><span class="p">),</span> <span class="p">))</span>

    <span class="k">def</span> <span class="nf">_comp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">tokens</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Perform comparison.&quot;&quot;&quot;</span>

        <span class="n">tokens</span> <span class="o">=</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">debug</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="s1">&#39;_comp&#39;</span><span class="p">,</span> <span class="n">tokens</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">NUMB</span><span class="p">:</span> <span class="k">return</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">3</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SelectionError</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span>
                                 <span class="s1">&#39;invalid number of operators and operands&#39;</span><span class="p">)</span>
        <span class="n">left</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getNumeric</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">tokens</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">err</span><span class="p">:</span> <span class="k">raise</span> <span class="n">err</span>

        <span class="n">torf</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">while</span> <span class="n">tokens</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">binop</span> <span class="o">=</span> <span class="n">OPERATORS</span><span class="p">[</span><span class="n">tokens</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">SelectionError</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="s1">&#39;invalid operator encountered&#39;</span><span class="p">)</span>

            <span class="n">right</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getNumeric</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">tokens</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">err</span><span class="p">:</span> <span class="k">raise</span> <span class="n">err</span>

            <span class="k">if</span> <span class="n">torf</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">torf</span> <span class="o">=</span> <span class="n">binop</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logical_and</span><span class="p">(</span><span class="n">binop</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">),</span> <span class="n">torf</span><span class="p">,</span> <span class="n">torf</span><span class="p">)</span>
            <span class="n">left</span> <span class="o">=</span> <span class="n">right</span>
        <span class="c1"># check whether atomic data was contained in comparison</span>
        <span class="c1"># i.e. len(atoms) == len(torf)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ndim</span><span class="p">,</span> <span class="n">shape</span> <span class="o">=</span> <span class="n">torf</span><span class="o">.</span><span class="n">ndim</span><span class="p">,</span> <span class="n">torf</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SelectionError</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span>
                                <span class="s1">&#39;comparison must contain atomic data&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ndim</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_atoms</span><span class="o">.</span><span class="n">numAtoms</span><span class="p">():</span>
                <span class="k">raise</span> <span class="n">SelectionError</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span>
                                    <span class="s1">&#39;comparison must contain atomic data&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">torf</span>

    <span class="k">def</span> <span class="nf">_binop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">tokens</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Perform binary operation.&quot;&quot;&quot;</span>

        <span class="n">tokens</span> <span class="o">=</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">debug</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="s1">&#39;_binop&#39;</span><span class="p">,</span> <span class="n">tokens</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">NUMB</span><span class="p">:</span> <span class="k">return</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">3</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SelectionError</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="s1">&#39;invalid number of items&#39;</span><span class="p">)</span>
        <span class="n">left</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getNumeric</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">tokens</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">copy</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">err</span><span class="p">:</span> <span class="k">raise</span> <span class="n">err</span>

        <span class="k">while</span> <span class="n">tokens</span><span class="p">:</span>
            <span class="n">binop</span> <span class="o">=</span> <span class="n">tokens</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">binop</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">OPERATORS</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">SelectionError</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="s1">&#39;invalid operator encountered&#39;</span><span class="p">)</span>

            <span class="n">right</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getNumeric</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">tokens</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">err</span><span class="p">:</span> <span class="k">raise</span> <span class="n">err</span>

            <span class="k">if</span> <span class="n">DEBUG</span><span class="p">:</span> <span class="k">print</span><span class="p">(</span><span class="n">binop</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">binop</span> <span class="o">==</span> <span class="s1">&#39;/&#39;</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="n">right</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">SelectionError</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="s1">&#39;zero division error&#39;</span><span class="p">)</span>
            <span class="n">binop</span> <span class="o">=</span> <span class="n">OPERATORS</span><span class="p">[</span><span class="n">binop</span><span class="p">]</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">ndim</span> <span class="o">=</span> <span class="n">left</span><span class="o">.</span><span class="n">ndim</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">left</span> <span class="o">=</span> <span class="n">binop</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># ndim must not be zero for in place operation</span>
                <span class="k">if</span> <span class="n">ndim</span><span class="p">:</span>
                    <span class="n">binop</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">left</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">left</span> <span class="o">=</span> <span class="n">binop</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">left</span>

    <span class="k">def</span> <span class="nf">_pow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">tokens</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Perform power operation. Expected operands are numbers</span>
<span class="sd">        and numeric atom attributes.&quot;&quot;&quot;</span>

        <span class="n">tokens</span> <span class="o">=</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">debug</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="s1">&#39;_pow&#39;</span><span class="p">,</span> <span class="n">tokens</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">NUMB</span><span class="p">:</span> <span class="k">return</span>

        <span class="n">base</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getNumeric</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">tokens</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">err</span><span class="p">:</span> <span class="k">raise</span> <span class="n">err</span>
        <span class="n">power</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getNumeric</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">tokens</span><span class="o">.</span><span class="n">pop</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">err</span><span class="p">:</span> <span class="k">raise</span> <span class="n">err</span>

        <span class="k">if</span> <span class="n">tokens</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;^&#39;</span><span class="p">,</span> <span class="s1">&#39;**&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">SelectionError</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="s1">&#39;invalid power operator&#39;</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">tokens</span><span class="p">:</span>
            <span class="n">number</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getNumeric</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span>   <span class="n">tokens</span><span class="o">.</span><span class="n">pop</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">err</span><span class="p">:</span> <span class="k">raise</span> <span class="n">err</span>
            <span class="n">power</span> <span class="o">=</span> <span class="n">number</span> <span class="o">**</span> <span class="n">power</span>
            <span class="k">if</span> <span class="n">tokens</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;^&#39;</span><span class="p">,</span> <span class="s1">&#39;**&#39;</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">SelectionError</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="s1">&#39;invalid power operator&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">base</span> <span class="o">**</span> <span class="n">power</span>

    <span class="k">def</span> <span class="nf">_sign</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">tokens</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Change the sign of a selection argument.&quot;&quot;&quot;</span>

        <span class="n">tokens</span> <span class="o">=</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">debug</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="s1">&#39;_sign&#39;</span><span class="p">,</span> <span class="n">tokens</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">NUMB</span><span class="p">:</span> <span class="k">return</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SelectionError</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span>
                                 <span class="s1">&#39;sign operators (+/-) must be followed &#39;</span>
                                 <span class="s1">&#39;by single keyword, e.g. &quot;-x&quot;, &quot;-beta&quot;&#39;</span><span class="p">)</span>
        <span class="n">arg</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getNumeric</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">err</span><span class="p">:</span> <span class="k">raise</span> <span class="n">err</span>

        <span class="k">if</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;-&#39;</span><span class="p">:</span>
            <span class="n">arg</span> <span class="o">=</span>  <span class="o">-</span><span class="n">arg</span>
        <span class="k">return</span> <span class="n">arg</span>

    <span class="k">def</span> <span class="nf">_func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">tokens</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Evaluate functions used in selection strings.&quot;&quot;&quot;</span>

        <span class="n">tokens</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">debug</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="s1">&#39;_func&#39;</span><span class="p">,</span> <span class="n">tokens</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">NUMB</span><span class="p">:</span> <span class="k">return</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SelectionError</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="s1">&#39;{0} accepts a single numeric &#39;</span>
                             <span class="s1">&#39;argument, e.g. {0}(x)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
        <span class="n">arg</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getNumeric</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">err</span><span class="p">:</span> <span class="k">raise</span> <span class="n">err</span>
        <span class="n">debug</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">arg</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">FUNCTIONS</span><span class="p">[</span><span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">]](</span><span class="n">arg</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_generic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">tokens</span><span class="p">,</span> <span class="n">subset</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="n">debug</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="s1">&#39;_generic&#39;</span><span class="p">,</span> <span class="n">tokens</span><span class="p">)</span>

        <span class="n">label</span> <span class="o">=</span> <span class="n">tokens</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">data</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getData</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">err</span><span class="p">:</span> <span class="k">return</span> <span class="bp">None</span><span class="p">,</span> <span class="n">err</span>

        <span class="k">if</span> <span class="n">subset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">subset</span><span class="p">]</span>
            <span class="n">subset</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">dtype</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span>
        <span class="n">type_</span> <span class="o">=</span> <span class="n">dtype</span><span class="o">.</span><span class="n">type</span>
        <span class="n">isstr</span> <span class="o">=</span> <span class="n">dtype</span><span class="o">.</span><span class="n">char</span> <span class="o">==</span> <span class="s1">&#39;S&#39;</span> <span class="ow">or</span> <span class="n">dtype</span><span class="o">.</span><span class="n">char</span> <span class="o">==</span> <span class="s1">&#39;U&#39;</span>
        <span class="k">if</span> <span class="n">isstr</span><span class="p">:</span>
            <span class="n">maxlen</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">dtype</span><span class="o">.</span><span class="n">str</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>
        <span class="n">torf</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">regexp</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">values</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ranges</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">valset</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">:</span>

            <span class="c1"># check for regular expressions which are only compatible with</span>
            <span class="c1"># string data type</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">token</span><span class="o">.</span><span class="n">pattern</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">isstr</span><span class="p">:</span>
                    <span class="n">ptrn</span> <span class="o">=</span> <span class="s1">&#39;&quot;{0}&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">pattern</span><span class="p">)</span>
                    <span class="n">SelectionWarning</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="s1">&#39;{0} is a regular &#39;</span>
                        <span class="s1">&#39;expression and is not evaluated for {1}&#39;</span>
                        <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ptrn</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">label</span><span class="p">)),</span> <span class="p">[</span><span class="n">label</span><span class="p">,</span> <span class="n">ptrn</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">regexp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
                <span class="k">continue</span>


            <span class="c1"># check for ranges</span>
            <span class="k">if</span> <span class="n">token</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;range&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">isstr</span><span class="p">:</span>
                    <span class="n">SelectionWarning</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="s1">&#39;number ranges &#39;</span>
                        <span class="s1">&#39;are not evaluated with data type of {0}&#39;</span>
                        <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">label</span><span class="p">)),</span> <span class="p">[</span><span class="n">label</span><span class="p">,</span> <span class="n">token</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">token</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">OPERATORS</span><span class="p">:</span>
                        <span class="n">ranges</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">nrange</span> <span class="o">=</span> <span class="n">arange</span><span class="p">(</span><span class="o">*</span><span class="n">token</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
                        <span class="c1"># if dtypes are not the same, don&#39;t use set method</span>
                        <span class="k">if</span> <span class="n">nrange</span><span class="o">.</span><span class="n">dtype</span> <span class="o">!=</span> <span class="n">dtype</span><span class="p">:</span> <span class="n">valset</span> <span class="o">=</span> <span class="bp">False</span>
                        <span class="n">values</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">nrange</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">isstr</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">token</span> <span class="o">==</span> <span class="s1">&#39;_&#39;</span><span class="p">:</span>
                    <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                    <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">token</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">maxlen</span><span class="p">:</span>
                        <span class="n">SelectionWarning</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="s1">&#39;{0} is longer than the &#39;</span>
                            <span class="s1">&#39;maximum characters for data field {1}&#39;</span>
                            <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">token</span><span class="p">),</span> <span class="nb">repr</span><span class="p">(</span><span class="n">label</span><span class="p">)),</span> <span class="p">[</span><span class="n">label</span><span class="p">,</span> <span class="n">token</span><span class="p">])</span>
                    <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">type_</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">SelectionWarning</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="s1">&#39;{0} could not be &#39;</span>
                        <span class="s1">&#39;converted to type of {1} ({2})&#39;</span>
                        <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">token</span><span class="p">),</span> <span class="nb">repr</span><span class="p">(</span><span class="n">label</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)),</span>
                        <span class="p">[</span><span class="n">label</span><span class="p">,</span> <span class="n">token</span><span class="p">])</span>
                    <span class="k">continue</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">val2</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">val2</span> <span class="o">!=</span> <span class="n">value</span><span class="p">:</span>
                        <span class="n">SelectionWarning</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="s1">&#39;{0} has a different &#39;</span>
                            <span class="s1">&#39;values when converted to a float and to type of &#39;</span>
                            <span class="s1">&#39;{1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">token</span><span class="p">),</span> <span class="nb">repr</span><span class="p">(</span><span class="n">label</span><span class="p">)),</span>
                            <span class="p">[</span><span class="n">label</span><span class="p">,</span> <span class="n">token</span><span class="p">])</span>
                <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">values</span><span class="p">:</span>
            <span class="c1"># use first option only if values and data array has the same dtype</span>
            <span class="k">if</span> <span class="n">valset</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
                <span class="n">valset</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
                <span class="n">torf</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="n">val</span> <span class="ow">in</span> <span class="n">values</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">data</span><span class="p">],</span> <span class="nb">bool</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">torf</span> <span class="o">=</span> <span class="n">data</span> <span class="o">==</span> <span class="n">values</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
                    <span class="n">subset</span> <span class="o">=</span> <span class="p">(</span><span class="n">torf</span> <span class="o">==</span> <span class="bp">False</span><span class="p">)</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">subset</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="n">torf</span><span class="p">,</span> <span class="bp">False</span>
                    <span class="n">torf</span><span class="p">[</span><span class="n">subset</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">subset</span><span class="p">]</span> <span class="o">==</span> <span class="n">val</span>

        <span class="k">if</span> <span class="n">ranges</span><span class="p">:</span>
            <span class="k">while</span> <span class="n">ranges</span><span class="p">:</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">comp</span> <span class="o">=</span> <span class="n">ranges</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">torf</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">torf</span> <span class="o">=</span> <span class="n">start</span> <span class="o">&lt;=</span> <span class="n">data</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">subset</span> <span class="o">=</span> <span class="p">(</span><span class="n">torf</span> <span class="o">==</span> <span class="bp">False</span><span class="p">)</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">subset</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="n">torf</span><span class="p">,</span> <span class="bp">False</span>
                    <span class="n">subdata</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">subset</span><span class="p">]</span>
                    <span class="n">torf</span><span class="p">[</span><span class="n">subset</span><span class="p">]</span> <span class="o">=</span> <span class="n">start</span> <span class="o">&lt;=</span> <span class="n">subdata</span>
                <span class="k">if</span> <span class="n">subset</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">torf</span> <span class="o">=</span> <span class="n">logical_and</span><span class="p">(</span><span class="n">torf</span><span class="p">,</span> <span class="n">OPERATORS</span><span class="p">[</span><span class="n">comp</span><span class="p">](</span><span class="n">data</span><span class="p">,</span> <span class="n">stop</span><span class="p">),</span> <span class="n">torf</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">torf</span><span class="p">[</span><span class="n">subset</span><span class="p">]</span> <span class="o">=</span> <span class="n">logical_and</span><span class="p">(</span><span class="n">torf</span><span class="p">[</span><span class="n">subset</span><span class="p">],</span>
                                       <span class="n">OPERATORS</span><span class="p">[</span><span class="n">comp</span><span class="p">](</span><span class="n">subdata</span><span class="p">,</span> <span class="n">stop</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">regexp</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">re</span> <span class="ow">in</span> <span class="n">regexp</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">torf</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">torf</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>
                                  <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">data</span><span class="p">],</span> <span class="nb">bool</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">subset</span> <span class="o">=</span> <span class="p">(</span><span class="n">torf</span> <span class="o">==</span> <span class="bp">False</span><span class="p">)</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">subset</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="n">torf</span><span class="p">,</span> <span class="bp">False</span>
                    <span class="n">torf</span><span class="p">[</span><span class="n">subset</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>
                                    <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="n">subset</span><span class="p">]]</span>
        <span class="k">if</span> <span class="n">torf</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">torf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getZeros</span><span class="p">(</span><span class="n">subset</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">torf</span><span class="p">,</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">tokens</span><span class="p">,</span> <span class="n">subset</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="n">debug</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="s1">&#39;_index&#39;</span><span class="p">,</span> <span class="n">tokens</span><span class="p">)</span>
        <span class="n">label</span> <span class="o">=</span> <span class="n">tokens</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">torf</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ag</span><span class="o">.</span><span class="n">numAtoms</span><span class="p">(),</span> <span class="nb">bool</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">remainder</span> <span class="o">=</span> <span class="n">token</span> <span class="o">%</span> <span class="mf">1.</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">None</span><span class="p">,</span> <span class="n">SelectionError</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="s1">&#39;it is a number, index&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">remainder</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">torf</span><span class="p">[</span><span class="n">token</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                        <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">SelectionWarning</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="s1">&#39;{0} must be followed by &#39;</span>
                        <span class="s1">&#39;integers and/or number ranges&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">label</span><span class="p">)),</span>
                        <span class="p">[</span><span class="n">label</span><span class="p">,</span> <span class="n">token</span><span class="p">])</span>
                <span class="k">continue</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">token</span><span class="o">.</span><span class="n">pattern</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ptrn</span> <span class="o">=</span> <span class="s1">&#39;&quot;{0}&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">pattern</span><span class="p">)</span>
                <span class="n">SelectionWarning</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="s1">&#39;{0} is a regular &#39;</span>
                    <span class="s1">&#39;expression and is not evaluated for {1}&#39;</span>
                    <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ptrn</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">label</span><span class="p">)),</span> <span class="p">[</span><span class="n">label</span><span class="p">,</span> <span class="n">ptrn</span><span class="p">])</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">token</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;range&#39;</span><span class="p">:</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">step</span> <span class="o">=</span> <span class="n">token</span>
                <span class="k">if</span> <span class="n">step</span> <span class="ow">in</span> <span class="n">OPERATORS</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">step</span> <span class="o">==</span> <span class="s1">&#39;&lt;=&#39;</span><span class="p">:</span>
                        <span class="n">stop</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">step</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">start</span> <span class="o">%</span> <span class="mf">1.0</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">stop</span> <span class="o">%</span> <span class="mf">1.0</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">step</span> <span class="o">%</span> <span class="mf">1.0</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">SelectionWarning</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="s1">&#39;{0} number ranges should be &#39;</span>
                        <span class="s1">&#39;specified by integers&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">label</span><span class="p">)),</span>
                        <span class="p">[</span><span class="n">label</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">start</span><span class="p">)])</span>
                <span class="n">torf</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">:</span><span class="n">step</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">continue</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">None</span><span class="p">,</span> <span class="n">SelectionError</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="s1">&#39;{0} must be &#39;</span>
                    <span class="s1">&#39;followed by integers and/or number ranges&#39;</span><span class="p">,</span>
                    <span class="p">[</span><span class="n">label</span><span class="p">,</span> <span class="n">token</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">val</span> <span class="o">%</span> <span class="mf">1.0</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">torf</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">val</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                        <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">SelectionWarning</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="s1">&#39;{0} must be followed by &#39;</span>
                        <span class="s1">&#39;integers and/or number ranges&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">label</span><span class="p">)),</span>
                        <span class="p">[</span><span class="n">label</span><span class="p">,</span> <span class="n">token</span><span class="p">])</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_atoms</span><span class="o">.</span><span class="n">_getIndices</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">torf</span> <span class="o">=</span> <span class="n">torf</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">subset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">torf</span> <span class="o">=</span> <span class="n">torf</span><span class="p">[</span><span class="n">subset</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">torf</span><span class="p">,</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">_serial</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">tokens</span><span class="p">,</span> <span class="n">subset</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="n">debug</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="s1">&#39;_serial&#39;</span><span class="p">,</span> <span class="n">tokens</span><span class="p">)</span>
        <span class="n">label</span> <span class="o">=</span> <span class="n">tokens</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">sn2i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ag</span><span class="o">.</span><span class="n">_getSN2I</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">sn2i</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span><span class="p">,</span> <span class="n">SelectionError</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="s1">&#39;serial numbers are not set&#39;</span>
                                        <span class="p">[</span><span class="s1">&#39;serial&#39;</span><span class="p">])</span>
        <span class="n">torf</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sn2i</span><span class="p">),</span> <span class="nb">bool</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">remainder</span> <span class="o">=</span> <span class="n">token</span> <span class="o">%</span> <span class="mf">1.</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">None</span><span class="p">,</span> <span class="n">SelectionError</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="s1">&#39;??? it is a number, serial&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">remainder</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">torf</span><span class="p">[</span><span class="n">token</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                        <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">SelectionWarning</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="s1">&#39;{0} must be followed by &#39;</span>
                        <span class="s1">&#39;integers and/or number ranges&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">label</span><span class="p">)),</span>
                        <span class="p">[</span><span class="n">label</span><span class="p">,</span> <span class="n">token</span><span class="p">])</span>
                <span class="k">continue</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">pattern</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">pattern</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ptrn</span> <span class="o">=</span> <span class="s1">&#39;&quot;{0}&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
                <span class="n">SelectionWarning</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="s1">&#39;{0} is a regular &#39;</span>
                    <span class="s1">&#39;expression and is not evaluated for {1}&#39;</span>
                    <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ptrn</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">label</span><span class="p">)),</span> <span class="p">[</span><span class="n">label</span><span class="p">,</span> <span class="n">ptrn</span><span class="p">])</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">token</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;range&#39;</span><span class="p">:</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">step</span> <span class="o">=</span> <span class="n">token</span>
                <span class="k">if</span> <span class="n">step</span> <span class="ow">in</span> <span class="n">OPERATORS</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">step</span> <span class="o">==</span> <span class="s1">&#39;&lt;=&#39;</span><span class="p">:</span>
                        <span class="n">stop</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">step</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">start</span> <span class="o">%</span> <span class="mf">1.0</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">stop</span> <span class="o">%</span> <span class="mf">1.0</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">step</span> <span class="o">%</span> <span class="mf">1.0</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">SelectionWarning</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="s1">&#39;{0} number ranges should be &#39;</span>
                        <span class="s1">&#39;specified by integers&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">label</span><span class="p">)),</span>
                        <span class="p">[</span><span class="n">label</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">start</span><span class="p">)])</span>
                <span class="n">torf</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">:</span><span class="n">step</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">continue</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">None</span><span class="p">,</span> <span class="n">SelectionError</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="s1">&#39;{0} must be &#39;</span>
                    <span class="s1">&#39;followed by integers and/or number ranges&#39;</span><span class="p">,</span>
                    <span class="p">[</span><span class="n">label</span><span class="p">,</span> <span class="n">token</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">val</span> <span class="o">%</span> <span class="mf">1.0</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">torf</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">val</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                        <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">SelectionWarning</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="s1">&#39;{0} must be followed by &#39;</span>
                        <span class="s1">&#39;integers and/or number ranges&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">label</span><span class="p">)),</span>
                        <span class="p">[</span><span class="n">label</span><span class="p">,</span> <span class="n">token</span><span class="p">])</span>

        <span class="n">indices</span> <span class="o">=</span> <span class="n">sn2i</span><span class="p">[</span><span class="n">torf</span><span class="p">]</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="n">indices</span><span class="p">[</span><span class="n">where</span><span class="p">(</span><span class="n">indices</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getZeros</span><span class="p">(</span><span class="n">subset</span><span class="p">),</span> <span class="bp">False</span>
        <span class="n">torf</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ag</span><span class="o">.</span><span class="n">numAtoms</span><span class="p">(),</span> <span class="nb">bool</span><span class="p">)</span>
        <span class="n">torf</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_atoms</span><span class="o">.</span><span class="n">_getIndices</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">torf</span> <span class="o">=</span> <span class="n">torf</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">subset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">torf</span> <span class="o">=</span> <span class="n">torf</span><span class="p">[</span><span class="n">subset</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">torf</span><span class="p">,</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">_resnum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">tokens</span><span class="p">,</span> <span class="n">subset</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="n">debug</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="s1">&#39;_resnum&#39;</span><span class="p">,</span> <span class="n">tokens</span><span class="p">)</span>
        <span class="n">label</span> <span class="o">=</span> <span class="n">tokens</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">resnums</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getData</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="s1">&#39;resnum&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">err</span><span class="p">:</span> <span class="k">return</span> <span class="bp">None</span><span class="p">,</span> <span class="n">err</span>
        <span class="n">wicode</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([])</span>
        <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;resnum&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">:</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">pattern</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">pattern</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ptrn</span> <span class="o">=</span> <span class="s1">&#39;&quot;{0}&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
                <span class="n">SelectionWarning</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="s1">&#39;{0} is a regular expression and &#39;</span>
                                 <span class="s1">&#39;its use with {1} is not recommended&#39;</span>
                                 <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ptrn</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">label</span><span class="p">)),</span> <span class="p">[</span><span class="n">label</span><span class="p">,</span> <span class="n">ptrn</span><span class="p">])</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">token</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;range&#39;</span><span class="p">:</span>
                <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
                <span class="n">icode</span> <span class="o">=</span> <span class="n">token</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">token</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">SelectionWarning</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="s1">&#39;{0} must be followed by &#39;</span>
                        <span class="s1">&#39;integers, number ranges, or integer and insertion &#39;</span>
                        <span class="s1">&#39;code combinations, e.g. {1}&#39;</span>
                        <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">label</span><span class="p">),</span> <span class="nb">repr</span><span class="p">(</span><span class="s1">&#39;10A&#39;</span><span class="p">)),</span>
                            <span class="p">[</span><span class="n">label</span><span class="p">,</span> <span class="n">token</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">wicode</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">value</span><span class="p">,</span> <span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="n">icode</span> <span class="o">==</span> <span class="s1">&#39;_&#39;</span> <span class="k">else</span> <span class="n">icode</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">value</span> <span class="o">!=</span> <span class="nb">int</span><span class="p">(</span><span class="n">token</span><span class="p">):</span>
                    <span class="n">SelectionWarning</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="s1">&#39;{0} must be followed by &#39;</span>
                        <span class="s1">&#39;integers and/or number ranges&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">label</span><span class="p">)),</span>
                        <span class="p">[</span><span class="n">label</span><span class="p">,</span> <span class="n">token</span><span class="p">])</span>
                <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
        <span class="n">torf</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">torf</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generic</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">subset</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">wicode</span><span class="p">:</span>
            <span class="n">icode</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getData</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="s1">&#39;icode&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">err</span><span class="p">:</span> <span class="k">return</span> <span class="bp">None</span><span class="p">,</span> <span class="n">err</span>
            <span class="k">if</span> <span class="n">subset</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">rnic</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">resnums</span><span class="p">,</span> <span class="n">icode</span><span class="p">)</span> <span class="c1"># PY3K: OK</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rnic</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">resnums</span><span class="p">[</span><span class="n">subset</span><span class="p">],</span> <span class="n">icode</span><span class="p">[</span><span class="n">subset</span><span class="p">])</span> <span class="c1"># PY3K: OK</span>

            <span class="k">if</span> <span class="n">torf</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">torf</span> <span class="o">=</span> <span class="n">array</span><span class="p">([</span><span class="n">val</span> <span class="ow">in</span> <span class="n">wicode</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">rnic</span><span class="p">],</span> <span class="nb">bool</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">torf</span> <span class="o">=</span> <span class="n">logical_or</span><span class="p">(</span><span class="n">torf</span><span class="p">,</span> <span class="n">array</span><span class="p">([</span><span class="n">val</span> <span class="ow">in</span> <span class="n">wicode</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">rnic</span><span class="p">],</span>
                                               <span class="nb">bool</span><span class="p">),</span> <span class="n">torf</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">torf</span><span class="p">,</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">_sequence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">tokens</span><span class="p">,</span> <span class="n">subset</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="n">debug</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="s1">&#39;_sequence&#39;</span><span class="p">,</span> <span class="n">tokens</span><span class="p">)</span>
        <span class="n">label</span> <span class="o">=</span> <span class="n">tokens</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">regexp</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">:</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">token</span><span class="o">.</span><span class="n">pattern</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">token</span><span class="o">.</span><span class="n">isalpha</span><span class="p">()</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">token</span><span class="o">.</span><span class="n">isupper</span><span class="p">():</span>
                    <span class="n">SelectionWarning</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="s1">&#39;{0} does not look like a &#39;</span>
                        <span class="s1">&#39;valid sequence&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">token</span><span class="p">)),</span>
                        <span class="p">[</span><span class="n">label</span><span class="p">,</span> <span class="n">token</span><span class="p">])</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">token</span> <span class="o">=</span> <span class="n">re_compile</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="n">SelectionWarning</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="s1">&#39;{0} could not be compiled &#39;</span>
                        <span class="s1">&#39;as a regular expression for sequence evaluation&#39;</span>
                        <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">token</span><span class="p">)),</span> <span class="p">[</span><span class="n">label</span><span class="p">,</span> <span class="n">token</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">regexp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">regexp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">regexp</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getZeros</span><span class="p">(</span><span class="n">subset</span><span class="p">),</span> <span class="bp">False</span>

        <span class="n">calpha</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_atoms</span><span class="o">.</span><span class="n">calpha</span>
        <span class="k">if</span> <span class="n">calpha</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getZeros</span><span class="p">(</span><span class="n">subset</span><span class="p">),</span> <span class="bp">False</span>

        <span class="n">matches</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">chain</span> <span class="ow">in</span> <span class="nb">iter</span><span class="p">(</span><span class="n">HierView</span><span class="p">(</span><span class="n">calpha</span><span class="p">)):</span>
            <span class="n">sequence</span> <span class="o">=</span> <span class="n">chain</span><span class="o">.</span><span class="n">getSequence</span><span class="p">()</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="n">chain</span><span class="o">.</span><span class="n">_getIndices</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">re</span> <span class="ow">in</span> <span class="n">regexp</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">sequence</span><span class="p">):</span>
                    <span class="n">matches</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">indices</span><span class="p">[</span><span class="n">match</span><span class="o">.</span><span class="n">start</span><span class="p">():</span><span class="n">match</span><span class="o">.</span><span class="n">end</span><span class="p">()])</span>

        <span class="k">if</span> <span class="n">matches</span><span class="p">:</span>
            <span class="n">torf</span> <span class="o">=</span> <span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ag</span><span class="o">.</span><span class="n">numAtoms</span><span class="p">(),</span> <span class="nb">bool</span><span class="p">)</span>
            <span class="n">torf</span><span class="p">[</span><span class="n">matches</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_indices</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">torf</span> <span class="o">=</span> <span class="n">torf</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_indices</span><span class="p">]</span>
            <span class="n">torf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sameas</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;same&#39;</span><span class="p">,</span> <span class="s1">&#39;residue&#39;</span><span class="p">,</span> <span class="s1">&#39;as&#39;</span><span class="p">),</span> <span class="n">torf</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">subset</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">torf</span><span class="p">,</span> <span class="bp">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">torf</span><span class="p">[</span><span class="n">subset</span><span class="p">],</span> <span class="bp">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getZeros</span><span class="p">(</span><span class="n">subset</span><span class="p">),</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">_getData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">keyword</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns atomic data.&quot;&quot;&quot;</span>

        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">keyword</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="bp">False</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">XYZ2INDEX</span><span class="p">[</span><span class="n">keyword</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getCoords</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span><span class="n">idx</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">keyword</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span>
            <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="bp">False</span>

        <span class="k">if</span> <span class="n">keyword</span> <span class="o">==</span> <span class="s1">&#39;index&#39;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_atoms</span><span class="o">.</span><span class="n">_getIndices</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_atoms</span><span class="o">.</span><span class="n">numAtoms</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span>
            <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="bp">False</span>

        <span class="n">field</span> <span class="o">=</span> <span class="n">ATOMIC_FIELDS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">FIELDS_SYNONYMS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">keyword</span><span class="p">,</span> <span class="n">keyword</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">field</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_atoms</span><span class="o">.</span><span class="n">_getData</span><span class="p">(</span><span class="n">keyword</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">None</span><span class="p">,</span> <span class="n">SelectionError</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="s1">&#39;{0} is not a valid &#39;</span>
                                       <span class="s1">&#39;data label&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">keyword</span><span class="p">)))</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="n">data</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">None</span><span class="p">,</span> <span class="n">SelectionError</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="s1">&#39;{0} is not a 1d &#39;</span>
                                      <span class="s1">&#39;array&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">keyword</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_atoms</span><span class="p">,</span> <span class="s1">&#39;_get&#39;</span> <span class="o">+</span> <span class="n">field</span><span class="o">.</span><span class="n">meth_pl</span><span class="p">)()</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">None</span><span class="p">,</span> <span class="n">SelectionError</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">None</span><span class="p">,</span> <span class="n">SelectionError</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="s1">&#39;{0} is not set&#39;</span>
                                                       <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">keyword</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">keyword</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span>
        <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">_getCoords</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns coordinates of atoms.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coords</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_coords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_atoms</span><span class="o">.</span><span class="n">_getCoords</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coords</span></div>
</pre></div>

    </div>
  </div>
</div>
<footer class="footer">
  <div class="row">
    <div class="span12">
      <p><small>
      &copy; Copyright 2010-2017, University of Pittsburgh.
      Last updated on Dec 06, 2017.
      Created using <a href="http://sphinx-doc.org">Sphinx</a> 1.3.5.
      </small></p>
    </div>
  </div>
  </div>
</footer>
<div id="codemodal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
    <h3 id="myModalLabel">Code Snippets</h3>
  </div>
  <div class="modal-body">
    <textarea id="codesnippets"></textarea>
  </div>
  <div class="modal-footer">
    <button class="btn btn-info" id="selectcode">Select Code</button>
    <!--
    <button class="btn btn-success" id="copycode" data-clipboard-target="codesnippets">Copy Code</button>
    -->
    <button class="btn" data-dismiss="modal" aria-hidden="true">Close</button>
  </div>
  <input type="hidden" id="zeroclipboardpath" value="../../../_static/js/zeroclipboard.swf">
</div>
  </body>
</html>